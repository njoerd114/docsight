<!DOCTYPE html>
<html lang="{{ lang }}" data-theme="{{ theme|default('dark') }}">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>DOCSight</title>
    <link rel="icon" type="image/png" href="/static/icon.png">
    <style>
        :root, [data-theme="dark"] {
            --bg: #1a1a2e;
            --surface: #16213e;
            --card: #0f3460;
            --text: #e0e0e0;
            --muted: #888;
            --good: #4caf50;
            --warn: #ff9800;
            --crit: #f44336;
            --accent: #00adb5;
            --info: #2196f3;
            --input-border: rgba(255,255,255,0.15);
            --overlay: rgba(0,0,0,0.5);
        }
        [data-theme="light"] {
            --bg: #f0f2f5;
            --surface: #ffffff;
            --card: #e8edf2;
            --text: #1a1a2e;
            --muted: #666;
            --good: #2e7d32;
            --warn: #e65100;
            --crit: #c62828;
            --accent: #00838f;
            --info: #1565c0;
            --input-border: #ccc;
            --overlay: rgba(0,0,0,0.3);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace;
            background: var(--bg);
            color: var(--text);
            overflow-x: hidden;
        }

        /* ── Topbar ── */
        .topbar {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 16px; background: var(--surface);
            border-bottom: 1px solid var(--input-border);
            position: sticky; top: 0; z-index: 50;
        }
        .topbar-left, .topbar-right {
            display: flex; align-items: center; gap: 10px;
            position: relative; z-index: 1;
        }
        .hamburger-btn {
            background: none; border: none; color: var(--text);
            font-size: 1.5em; cursor: pointer; padding: 2px 6px;
            border-radius: 4px; line-height: 1;
        }
        .hamburger-btn:hover { color: var(--accent); }
        .date-nav {
            display: flex; align-items: center; justify-content: center; gap: 2px;
            padding: 12px 0; text-align: center;
        }
        .date-nav button {
            background: none; border: 1px solid var(--input-border);
            color: var(--text); border-radius: 4px; cursor: pointer;
            font-size: 0.85em; padding: 4px 8px;
        }
        .date-nav button:hover { border-color: var(--accent); color: var(--accent); }
        .date-label {
            font-size: 0.9em; font-weight: bold; padding: 4px 10px;
            cursor: pointer; border: 1px solid transparent;
            border-radius: 4px; white-space: nowrap;
        }
        .date-label:hover { border-color: var(--accent); }
        .topbar-title {
            font-size: 1.1em; color: var(--accent);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .topbar-meta { font-size: 0.8em; color: var(--muted); white-space: nowrap; }
        .lang-select {
            background: var(--surface); color: var(--muted); border: 1px solid var(--border);
            border-radius: 6px; padding: 4px 6px; font-size: 0.8em; cursor: pointer;
            font-family: inherit;
        }
        .lang-select:hover { color: var(--accent); border-color: var(--accent); }
        .theme-toggle {
            background: none; border: 1px solid var(--input-border);
            color: var(--muted); font-size: 1.1em; cursor: pointer;
            padding: 4px 8px; border-radius: 4px; line-height: 1;
        }
        .theme-toggle:hover { color: var(--accent); border-color: var(--accent); }
        .refresh-btn {
            background: none; border: 1px solid var(--input-border);
            color: var(--muted); font-size: 1.1em; cursor: pointer;
            padding: 4px 8px; border-radius: 4px; line-height: 1;
            transition: color 0.2s, border-color 0.2s;
        }
        .refresh-btn:hover { color: var(--accent); border-color: var(--accent); }
        .refresh-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .refresh-btn.spinning { animation: spin 1s linear infinite; }
        .toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 10px 20px; border-radius: 6px; font-size: 0.9em; z-index: 300;
            opacity: 0; transition: opacity 0.3s; pointer-events: none;
        }
        .toast.show { opacity: 1; }
        .toast-success { background: var(--good); color: #fff; }
        .toast-error { background: var(--crit); color: #fff; }

        /* ── Layout ── */
        .app-layout { display: flex; height: 100vh; overflow: hidden; }

        /* ── Sidebar ── */
        .sidebar {
            width: 240px; min-width: 240px;
            background: var(--surface);
            display: flex; flex-direction: column;
            border-right: 1px solid var(--input-border);
            transition: width 0.25s ease, min-width 0.25s ease;
            overflow: hidden;
        }
        .sidebar.collapsed { width: 0; min-width: 0; }
        .sidebar-content { flex: 1; overflow-y: auto; display: flex; flex-direction: column; }
        .sidebar-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px 20px; border-bottom: 1px solid var(--input-border);
            font-weight: bold; color: var(--accent); white-space: nowrap;
        }
        .sidebar-toggle {
            background: none; border: none; color: var(--muted);
            font-size: 1.2em; cursor: pointer; line-height: 1; padding: 2px 4px;
        }
        .sidebar-toggle:hover { color: var(--accent); }
        .app-main { flex: 1; min-width: 0; display: flex; flex-direction: column; overflow-y: auto; }
        .sidebar-link {
            display: flex; align-items: center; gap: 10px;
            padding: 12px 20px; color: var(--text); text-decoration: none;
            font-size: 0.95em; cursor: pointer; transition: background 0.15s;
        }
        .sidebar-link:hover { background: var(--card); }
        .sidebar-link.active { color: var(--accent); background: rgba(0,173,181,0.1); }
        .sidebar-link .icon { font-size: 1.1em; width: 24px; text-align: center; }
        .recording-dot { color: #e74c3c; animation: blink-recording 1.5s ease-in-out infinite; }
        @keyframes blink-recording { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }
        .sidebar-divider { border-top: 1px solid var(--input-border); margin: 8px 0; }
        .sidebar-section-label {
            text-transform: uppercase; font-size: 0.7em; color: var(--muted);
            padding: 12px 16px 4px; letter-spacing: 0.05em; pointer-events: none;
        }
        /* sidebar-ref removed */

        /* ── Calendar Popup ── */
        .calendar-popup {
            position: fixed; top: 52px; left: 80px;
            background: var(--surface); border: 1px solid var(--input-border);
            border-radius: 8px; padding: 12px; z-index: 80; display: none;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3); min-width: 280px;
        }
        .calendar-popup.open { display: block; }
        .cal-nav {
            display: flex; justify-content: space-between;
            align-items: center; margin-bottom: 8px;
        }
        .cal-nav button {
            background: none; border: 1px solid var(--input-border);
            color: var(--text); border-radius: 4px; cursor: pointer;
            padding: 4px 10px; font-size: 0.9em;
        }
        .cal-nav button:hover { border-color: var(--accent); }
        .cal-nav span { font-weight: bold; font-size: 0.95em; }
        .cal-weekdays {
            display: grid; grid-template-columns: repeat(7, 1fr);
            text-align: center; font-size: 0.75em; color: var(--muted); margin-bottom: 4px;
        }
        .cal-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .cal-day {
            text-align: center; padding: 6px 2px; font-size: 0.85em;
            border-radius: 4px; cursor: default; color: var(--muted);
        }
        .cal-day.has-data { color: var(--text); cursor: pointer; font-weight: bold; }
        .cal-day.has-data:hover { background: var(--card); }
        .cal-day.today { border: 1px solid var(--accent); }
        .cal-day.selected { background: var(--accent); color: #000; }
        .cal-day.empty { visibility: hidden; }

        /* ── Main Content ── */
        .main-content { padding: 16px; max-width: 1400px; margin: 0 auto; }
        .view { display: none; }
        .view.active { display: block; }

        /* ── Dashboard ── */
        .history-banner {
            padding: 10px 16px; border-radius: 6px;
            background: rgba(33,150,243,0.15); border: 1px solid var(--info);
            color: var(--info); font-size: 0.95em; margin-bottom: 16px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .history-banner a { color: var(--info); font-size: 0.85em; }
        .health-banner {
            padding: 16px 20px; border-radius: 8px; margin-bottom: 16px;
        }
        .health-good { background: rgba(76,175,80,0.1); border: 1px solid var(--good); }
        .health-warn { background: rgba(255,152,0,0.1); border: 1px solid var(--warn); }
        .health-crit { background: rgba(244,67,54,0.1); border: 1px solid var(--crit); }
        .health-status { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }
        .health-icon { font-size: 1.4em; }
        .health-good .health-icon { color: var(--good); }
        .health-warn .health-icon { color: var(--warn); }
        .health-crit .health-icon { color: var(--crit); }
        .health-title { font-size: 1.15em; font-weight: bold; }
        .health-good .health-title { color: var(--good); }
        .health-warn .health-title { color: var(--warn); }
        .health-crit .health-title { color: var(--crit); }
        .health-msg { font-size: 0.9em; color: var(--text); opacity: 0.85; margin-bottom: 4px; }
        .health-issues { margin-top: 10px; display: flex; flex-direction: column; gap: 8px; }
        .health-issue {
            padding: 8px 12px; border-radius: 6px;
            background: rgba(0,0,0,0.15);
        }
        .health-issue-name { font-weight: bold; font-size: 0.9em; display: block; }
        .health-issue-desc { font-size: 0.82em; color: var(--muted); margin-top: 2px; display: block; }
        h2.section-title { font-size: 1.1em; margin: 16px 0 8px; color: var(--accent); }
        /* ── Connection Info Bar ── */
        .conn-info-bar {
            background: var(--surface); border-radius: 6px; padding: 10px 16px;
            font-size: 0.9em; color: var(--muted); margin-bottom: 12px;
            display: flex; align-items: center; gap: 6px;
        }
        .conn-info-bar .conn-sep { opacity: 0.4; }

        /* ── Metric Cards Grid ── */
        .metric-cards {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 12px; margin-bottom: 16px;
        }

        /* ── Metric Card ── */
        .metric-card {
            background: var(--surface); border-radius: 6px;
            border-left: 4px solid var(--muted); overflow: hidden;
        }
        .metric-card.health-good { border-left-color: var(--good); }
        .metric-card.health-warn { border-left-color: var(--warn); }
        .metric-card.health-crit { border-left-color: var(--crit); }

        .metric-card-header {
            display: flex; align-items: center; gap: 8px;
            padding: 12px 14px 0; cursor: pointer; user-select: none;
        }
        .metric-card-header .status-dot {
            width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
        }
        .health-good .status-dot { background: var(--good); }
        .health-warn .status-dot { background: var(--warn); }
        .health-crit .status-dot { background: var(--crit); }
        .metric-card-header .card-title {
            font-size: 0.75em; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.05em; color: var(--muted); flex: 1;
        }
        .metric-card-header .chevron {
            font-size: 0.7em; color: var(--muted); transition: transform 0.25s ease;
        }
        .metric-card.open .metric-card-header .chevron { transform: rotate(90deg); }

        .metric-card-body { padding: 8px 14px 14px; }

        /* ── Metric Row (side-by-side metrics) ── */
        .metric-row { display: flex; gap: 20px; }
        .metric-item { flex: 1; min-width: 0; }
        .metric-value {
            font-size: 1.6em; font-weight: bold; line-height: 1.2;
        }
        .metric-value.val-good { color: var(--good); }
        .metric-value.val-warn { color: var(--warn); }
        .metric-value.val-crit { color: var(--crit); }
        .metric-unit { font-size: 0.7em; font-weight: normal; color: var(--muted); margin-left: 2px; }
        .metric-label { font-size: 0.78em; color: var(--muted); margin-top: 2px; }

        /* ── Range Indicator ── */
        .range-indicator {
            position: relative; height: 6px; border-radius: 3px;
            margin-top: 8px; display: flex; overflow: visible;
        }
        .range-zone { height: 100%; }
        .range-zone:first-child { border-radius: 3px 0 0 3px; }
        .range-zone:last-of-type { border-radius: 0 3px 3px 0; }
        .range-good { background: var(--good); opacity: 0.25; }
        .range-warn { background: var(--warn); opacity: 0.25; }
        .range-crit { background: var(--crit); opacity: 0.25; }
        .range-marker {
            position: absolute; top: -4px; width: 3px; height: 14px;
            border-radius: 1.5px; transform: translateX(-50%);
            transition: left 0.4s ease;
        }
        .range-marker.val-good { background: var(--good); }
        .range-marker.val-warn { background: var(--warn); }
        .range-marker.val-crit { background: var(--crit); }
        .range-labels {
            display: flex; justify-content: space-between;
            font-size: 0.6em; color: var(--muted); margin-top: 3px;
        }

        /* ── Gauge Bar (errors only) ── */
        .gauge-bar {
            height: 4px; background: rgba(255,255,255,0.08); border-radius: 2px;
            margin-top: 6px; overflow: hidden;
        }
        [data-theme="light"] .gauge-bar { background: rgba(0,0,0,0.08); }
        .gauge-fill { height: 100%; border-radius: 2px; transition: width 0.4s ease; }
        .gauge-fill.val-good { background: var(--good); }
        .gauge-fill.val-warn { background: var(--warn); }
        .gauge-fill.val-crit { background: var(--crit); }

        /* ── Secondary Value (errors card) ── */
        .metric-secondary {
            font-size: 0.85em; color: var(--muted); margin-top: 6px;
        }
        .metric-secondary strong { color: var(--text); font-weight: 600; }

        /* ── Card Detail (expandable) ── */
        .metric-card-detail {
            max-height: 0; overflow: hidden;
            transition: max-height 0.3s ease;
            padding: 0 14px;
        }
        .metric-card.open .metric-card-detail { max-height: 300px; }
        .detail-table {
            width: 100%; font-size: 0.82em; border-collapse: collapse;
            margin: 8px 0 12px;
        }
        .detail-table td { padding: 4px 0; }
        .detail-table td:first-child { color: var(--muted); padding-right: 12px; }
        .detail-note {
            font-size: 0.78em; color: var(--muted); font-style: italic;
            padding-bottom: 12px;
        }
        .card-notice {
            font-size: 0.78em; padding: 6px 10px; margin-top: 8px;
            border-radius: 4px; display: flex; align-items: center; gap: 6px;
        }
        .card-notice-warn {
            background: rgba(255,152,0,0.1); color: var(--warn);
        }

        /* ── Tables ── */
        table { width: 100%; border-collapse: collapse; margin-bottom: 16px; font-size: 0.9em; }
        th, td { padding: 6px 10px; text-align: left; }
        th {
            background: var(--surface); color: var(--accent);
            position: sticky; top: 52px; cursor: pointer; user-select: none;
            white-space: nowrap;
        }
        th:hover { text-decoration: underline; }
        th.sort-asc::after { content: " \25B2"; font-size: 0.65em; }
        th.sort-desc::after { content: " \25BC"; font-size: 0.65em; }
        tr { border-bottom: 1px solid rgba(255,255,255,0.05); }
        tr:hover { background: rgba(255,255,255,0.03); }
        .badge {
            display: inline-block; padding: 2px 8px; border-radius: 4px;
            font-size: 0.8em; font-weight: bold;
        }
        .badge-good { background: rgba(76,175,80,0.25); color: var(--good); }
        .badge-warn { background: rgba(255,152,0,0.25); color: var(--warn); }
        .badge-crit { background: rgba(244,67,54,0.25); color: var(--crit); }
        .val-good { color: var(--good); }
        .val-warn { color: var(--warn); }
        .val-crit { color: var(--crit); }
        .val-bad { color: #e74c3c; font-weight: 600; }
        #speedtest-table th { cursor: pointer; user-select: none; }
        #speedtest-table th:hover { background: var(--surface-hover, rgba(255,255,255,0.05)); }
        #speedtest-table th.st-expand-col, #speedtest-table td.st-expand-col {
            width: 32px; text-align: center; cursor: pointer; padding: 4px;
        }
        .st-expand-btn {
            background: none; border: none; cursor: pointer; font-size: 0.7em;
            color: var(--muted); transition: transform 0.2s; display: inline-block;
            padding: 4px 6px; line-height: 1;
        }
        .st-expand-btn:hover { color: var(--accent); }
        .st-expand-btn.open { transform: rotate(90deg); }
        .st-signal-row td { padding: 0 !important; border-top: none !important; }
        .st-signal-detail {
            background: var(--surface); border-radius: 6px; margin: 4px 8px 8px;
            padding: 10px 14px; font-size: 0.85em;
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px 16px;
        }
        .st-signal-detail .st-sig-item { display: flex; flex-direction: column; gap: 2px; }
        .st-signal-detail .st-sig-label { color: var(--muted); font-size: 0.8em; }
        .st-signal-detail .st-sig-value { font-weight: 600; }
        .st-signal-detail .st-health-badge {
            display: inline-block; padding: 2px 8px; border-radius: 4px;
            font-size: 0.8em; font-weight: 600;
        }
        .st-health-badge.health-good { background: rgba(76,175,80,0.2); color: var(--good); }
        .st-health-badge.health-marginal { background: rgba(255,152,0,0.2); color: var(--warn); }
        .st-health-badge.health-poor { background: rgba(244,67,54,0.2); color: var(--crit); }
        .st-signal-detail .st-sig-no-data { color: var(--muted); font-style: italic; grid-column: 1 / -1; }
        .st-signal-detail .st-us-mods { grid-column: 1 / -1; }
        .st-signal-detail .st-us-mods span { margin-right: 10px; }
        .speedtest-chart-wrap {
            position: relative; width: 100%;
            border: 1px solid var(--input-border); border-radius: 8px;
            background: var(--surface); margin-bottom: 24px;
            padding-bottom: 8px;
        }
        .speedtest-chart-wrap canvas { display: block; width: 100%; height: 250px; }
        .speedtest-chart-legend {
            display: flex; gap: 18px; justify-content: center;
            padding: 8px 0 4px; font-size: 0.78em; color: var(--muted);
        }
        .speedtest-chart-legend span::before {
            content: ''; display: inline-block; width: 10px; height: 10px;
            border-radius: 50%; margin-right: 5px; vertical-align: -1px;
        }
        .legend-dl::before { background: #3b82f6; }
        .legend-ul::before { background: #22c55e; }
        .legend-ping::before { background: #f59e0b; }
        .legend-thresh::before { background: #ef4444; }
        .speedtest-chart-tooltip {
            position: absolute; pointer-events: none; display: none;
            background: rgba(0,0,0,0.85); color: #e0e0e0; font-size: 0.78em;
            padding: 6px 10px; border-radius: 6px; white-space: nowrap; z-index: 1000;
        }
        .sort-indicator { margin-left: 4px; font-size: 0.8em; opacity: 0.7; }
        .error-box {
            background: rgba(244,67,54,0.15); border: 1px solid var(--crit);
            color: var(--crit); padding: 12px; border-radius: 6px; margin-bottom: 16px;
        }
        .waiting {
            text-align: center; padding: 60px 20px; color: var(--muted);
        }
        .waiting .spinner {
            display: inline-block; width: 30px; height: 30px;
            border: 3px solid var(--surface); border-top: 3px solid var(--accent);
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 12px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ── Collapsible Channel Groups ── */
        details.channel-group { margin-bottom: 4px; }
        details.channel-group summary {
            cursor: pointer; padding: 8px 12px; background: var(--surface);
            border-radius: 6px; font-size: 0.95em; font-weight: bold;
            color: var(--accent); list-style: none;
            display: flex; align-items: center; gap: 8px; user-select: none;
        }
        details.channel-group summary .badge { margin-left: auto; }
        details.channel-group summary::-webkit-details-marker { display: none; }
        details.channel-group summary::before {
            content: "\25B6"; font-size: 0.65em; transition: transform 0.2s;
        }
        details.channel-group[open] summary::before { transform: rotate(90deg); }
        details.channel-group table { margin-top: 4px; }

        /* ── Trends ── */
        .trend-header {
            display: flex; justify-content: space-between;
            align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 10px;
        }
        .trend-title { font-size: 1.2em; color: var(--accent); font-weight: bold; }
        .trend-tabs {
            display: flex; gap: 0; border-radius: 6px; overflow: hidden;
            border: 1px solid var(--input-border);
        }
        .trend-tab {
            background: transparent; border: none; color: var(--muted);
            padding: 6px 16px; font-size: 0.85em; cursor: pointer;
            font-family: inherit; transition: background 0.15s, color 0.15s;
            border-right: 1px solid var(--input-border);
        }
        .trend-tab:last-child { border-right: none; }
        .trend-tab:hover { color: var(--text); background: rgba(0,173,181,0.05); }
        .trend-tab.active { background: var(--accent); color: #000; font-weight: bold; }
        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .chart-card { background: var(--surface); border-radius: 8px; padding: 16px; position: relative; }
        .chart-card .chart-label { font-size: 0.85em; color: var(--muted); margin-bottom: 8px; }
        .chart-card canvas { width: 100% !important; }
        .chart-expand-btn {
            position: absolute; top: 10px; right: 10px;
            background: none; border: 1px solid transparent;
            color: var(--muted); font-size: 1em; cursor: pointer;
            padding: 2px 6px; border-radius: 4px; line-height: 1;
            opacity: 0.5; transition: opacity 0.2s, color 0.2s, border-color 0.2s;
            z-index: 2;
        }
        .chart-expand-btn:hover { opacity: 1; color: var(--accent); border-color: var(--accent); }
        .mod-timeline { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
        .mod-badge { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 0.82em; font-weight: 600; background: rgba(0,173,181,0.15); color: var(--accent); }
        .mod-badge-changed { background: rgba(255,152,0,0.2); color: var(--warn); }
        .mod-badge .mod-ts { font-size: 0.8em; opacity: 0.7; margin-right: 4px; }

        /* ── Chart Zoom Modal ── */
        .chart-zoom-overlay {
            position: fixed; inset: 0; background: var(--overlay);
            z-index: 200; display: none; justify-content: center; align-items: center;
        }
        .chart-zoom-overlay.open { display: flex; }
        .chart-zoom-modal {
            background: var(--surface); border-radius: 10px;
            padding: 20px; width: 90vw; height: 80vh;
            display: flex; flex-direction: column;
            border: 1px solid var(--input-border);
            box-shadow: 0 12px 40px rgba(0,0,0,0.4);
        }
        .chart-zoom-modal .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .chart-zoom-modal .modal-header h2 { font-size: 1.1em; color: var(--accent); margin: 0; }
        .chart-zoom-modal canvas { flex: 1; min-height: 0; width: 100% !important; }
        .no-data-msg {
            text-align: center; padding: 40px 20px;
            color: var(--muted); font-size: 0.95em;
        }

        /* ── Export Modal ── */
        .modal-overlay {
            position: fixed; inset: 0; background: var(--overlay);
            z-index: 200; display: none; justify-content: center; align-items: center;
        }
        .modal-overlay.open { display: flex; }
        .modal {
            background: var(--surface); border-radius: 10px;
            padding: 20px; max-width: 720px; width: 90%; max-height: 85vh;
            display: flex; flex-direction: column;
            border: 1px solid var(--input-border);
            box-shadow: 0 12px 40px rgba(0,0,0,0.4);
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 8px;
        }
        .modal-header h2 { font-size: 1.1em; color: var(--accent); margin: 0; }
        .modal-close {
            background: none; border: none; color: var(--muted);
            font-size: 1.4em; cursor: pointer; line-height: 1;
        }
        .modal-close:hover { color: var(--text); }
        .modal-hint { font-size: 0.85em; color: var(--muted); margin-bottom: 12px; }
        .modal-body {
            flex: 1; overflow-y: auto; margin-bottom: 12px;
        }
        .modal-body textarea {
            width: 100%; min-height: 300px; background: var(--bg);
            color: var(--text); border: 1px solid var(--input-border);
            border-radius: 6px; padding: 12px; font-size: 0.82em;
            font-family: 'Consolas', 'Monaco', monospace; resize: vertical;
        }
        .modal-footer { display: flex; gap: 10px; justify-content: flex-end; }
        .modal-footer .btn {
            display: inline-block; padding: 8px 20px; border: none;
            border-radius: 4px; cursor: pointer; font-size: 0.9em;
            font-family: inherit; font-weight: bold;
        }
        .btn-accent { background: var(--accent); color: #000; }
        .btn-accent:hover { filter: brightness(1.15); }
        .btn-muted {
            background: var(--card); color: var(--text);
            border: 1px solid var(--input-border);
        }
        .btn-muted:hover { background: var(--accent); color: #000; }

        /* ── Journal ── */
        .journal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 16px; flex-wrap: wrap; gap: 10px;
        }
        .journal-header .trend-title { font-size: 1.2em; color: var(--accent); font-weight: bold; }
        .btn-new-entry {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 8px 18px; background: var(--accent); color: #000;
            border: none; border-radius: 6px; cursor: pointer;
            font-size: 0.9em; font-family: inherit; font-weight: bold;
        }
        .btn-new-entry:hover { filter: brightness(1.15); }
        #journal-table { margin-bottom: 0; }
        #journal-table th { cursor: pointer; user-select: none; white-space: nowrap; }
        #journal-table th:hover { background: var(--surface-hover, rgba(255,255,255,0.05)); }
        #journal-table tbody tr { cursor: pointer; transition: background 0.15s; }
        #journal-table tbody tr:hover { background: rgba(255,255,255,0.06); }
        #journal-table td.journal-desc { color: var(--muted); font-size: 0.88em; }
        #journal-table td.journal-clip { color: var(--muted); font-size: 0.85em; text-align: center; }
        .journal-empty {
            text-align: center; padding: 60px 20px; color: var(--muted); font-size: 0.95em;
        }
        /* ── Event Log ── */
        .events-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 16px; flex-wrap: wrap; gap: 10px;
        }
        .events-header .trend-title { font-size: 1.2em; color: var(--accent); font-weight: bold; }
        .events-filters {
            display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;
        }
        .events-filters select {
            padding: 6px 10px; border-radius: 6px; border: 1px solid var(--input-border);
            background: var(--card); color: var(--text); font-size: 0.85em; font-family: inherit;
        }
        #events-table { margin-bottom: 0; }
        #events-table tbody tr { transition: background 0.15s; }
        #events-table tbody tr:hover { background: rgba(255,255,255,0.06); }
        #events-table tbody tr.event-acked { opacity: 0.5; }
        #events-table td.event-msg { max-width: 400px; word-break: break-word; }
        #events-table td.event-actions { white-space: nowrap; }
        .event-badge {
            display: inline-block; min-width: 18px; height: 18px; line-height: 18px;
            padding: 0 5px; border-radius: 9px; font-size: 0.7em; font-weight: bold;
            text-align: center; background: var(--crit); color: #fff; margin-left: 6px;
        }
        .sev-info { color: var(--accent); }
        .sev-warning { color: var(--warn); }
        .sev-critical { color: var(--crit); }
        .sev-badge-info { background: rgba(0,173,181,0.2); color: var(--accent); padding: 2px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; }
        .sev-badge-warning { background: rgba(255,152,0,0.25); color: var(--warn); padding: 2px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; }
        .sev-badge-critical { background: rgba(244,67,54,0.25); color: var(--crit); padding: 2px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; }
        .btn-ack {
            padding: 4px 10px; border: 1px solid var(--input-border); border-radius: 4px;
            background: transparent; color: var(--muted); cursor: pointer; font-size: 0.8em; font-family: inherit;
        }
        .btn-ack:hover { background: var(--surface); color: var(--text); }
        .btn-ack-all {
            padding: 6px 14px; border: 1px solid var(--input-border); border-radius: 6px;
            background: transparent; color: var(--text); cursor: pointer; font-size: 0.85em; font-family: inherit;
        }
        .btn-ack-all:hover { background: var(--surface); }
        .event-detail-row td { padding: 8px 16px !important; background: var(--surface); font-size: 0.85em; }
        .event-detail-row pre { margin: 0; white-space: pre-wrap; word-break: break-all; color: var(--muted); font-size: 0.9em; }
        .events-empty {
            text-align: center; padding: 60px 20px; color: var(--muted); font-size: 0.95em;
        }
        .incident-form-group { margin-bottom: 14px; }
        .incident-form-group label {
            display: block; font-size: 0.85em; color: var(--muted);
            margin-bottom: 4px; font-weight: bold;
        }
        .incident-form-group input,
        .incident-form-group textarea {
            width: 100%; padding: 10px 12px; background: var(--bg);
            color: var(--text); border: 1px solid var(--input-border);
            border-radius: 6px; font-family: inherit; font-size: 0.92em;
        }
        .incident-form-group textarea { min-height: 150px; resize: vertical; }
        .incident-form-group input:focus,
        .incident-form-group textarea:focus { outline: none; border-color: var(--accent); }
        .attachment-list { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; }
        .attachment-item {
            display: flex; align-items: center; gap: 8px;
            background: var(--card); border-radius: 6px; padding: 6px 10px;
            font-size: 0.82em; border: 1px solid var(--input-border);
        }
        .attachment-thumb {
            width: 48px; height: 48px; object-fit: cover; border-radius: 4px;
            background: var(--bg);
        }
        .attachment-icon {
            width: 48px; height: 48px; display: flex; align-items: center;
            justify-content: center; font-size: 1.5em; background: var(--bg);
            border-radius: 4px;
        }
        .attachment-info { display: flex; flex-direction: column; gap: 2px; }
        .attachment-name { color: var(--text); word-break: break-all; }
        .attachment-actions { display: flex; gap: 4px; }
        .attachment-actions a,
        .attachment-actions button {
            background: none; border: none; color: var(--muted); cursor: pointer;
            font-size: 0.9em; padding: 2px 4px; text-decoration: none;
        }
        .attachment-actions a:hover,
        .attachment-actions button:hover { color: var(--accent); }
        .btn-upload {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 6px 14px; background: var(--card); color: var(--text);
            border: 1px solid var(--input-border); border-radius: 6px;
            cursor: pointer; font-size: 0.85em; font-family: inherit;
        }
        .btn-upload:hover { border-color: var(--accent); color: var(--accent); }
        .btn-danger {
            background: var(--crit); color: #fff; border: none;
            padding: 8px 18px; border-radius: 4px; cursor: pointer;
            font-size: 0.9em; font-family: inherit; font-weight: bold;
        }
        .btn-danger:hover { filter: brightness(1.15); }
        .modal-footer-left { display: flex; gap: 10px; flex: 1; }
        .incident-modal-footer {
            display: flex; justify-content: space-between; align-items: center; gap: 10px;
        }
        .upload-spinner {
            display: inline-block; width: 16px; height: 16px;
            border: 2px solid var(--input-border); border-top: 2px solid var(--accent);
            border-radius: 50%; animation: spin 0.8s linear infinite;
            vertical-align: middle; margin-left: 6px;
        }

        /* ── Sidebar overlay backdrop ── */
        .sidebar-backdrop {
            display: none; position: fixed; inset: 0;
            background: var(--overlay); z-index: 59;
        }
        .sidebar-backdrop.active { display: block; }

        /* ── Info-tip tooltips (CSS-only) ── */
        .info-tip {
            position: relative;
            display: inline-block;
            cursor: help;
            margin-left: 4px;
            vertical-align: middle;
        }
        .info-tip .tip-icon {
            font-size: 0.78em;
            color: var(--muted);
            opacity: 0.7;
            font-style: normal;
        }
        .info-tip .tip-text {
            visibility: hidden;
            opacity: 0;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: var(--surface);
            color: var(--text);
            border: 1px solid var(--input-border);
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 0.82em;
            font-weight: normal;
            line-height: 1.5;
            white-space: normal;
            width: max-content;
            max-width: min(320px, 85vw);
            z-index: 1000;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            transition: opacity 0.15s ease, visibility 0.15s ease;
            pointer-events: none;
        }
        .info-tip .tip-text::after {
            display: none;
        }
        .info-tip:hover .tip-text,
        .info-tip:focus-within .tip-text {
            visibility: visible;
            opacity: 1;
        }
        .info-tip .tip-icon:focus {
            outline: 1px solid var(--accent);
            outline-offset: 2px;
            border-radius: 2px;
        }
        [data-theme="light"] .info-tip .tip-text {
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        /* ── Responsive ── */
        @media (max-width: 900px) {
            .charts-grid { grid-template-columns: 1fr; }
            .metric-cards { grid-template-columns: 1fr; }
            .sidebar {
                position: fixed; top: 0; left: 0; bottom: 0;
                z-index: 60; width: 240px; min-width: 240px;
                transform: translateX(-100%);
                transition: transform 0.25s ease;
            }
            .sidebar.collapsed { width: 240px; min-width: 240px; transform: translateX(-100%); }
            .sidebar.mobile-open { transform: translateX(0); }
        }
        @media (max-width: 600px) {
            body { font-size: 14px; }
            .topbar { gap: 6px; padding: 8px 10px; }
            .topbar-title { display: none; }
            .topbar-meta { display: none; }
            .metric-cards { grid-template-columns: 1fr; }
            .metric-row { flex-direction: column; gap: 10px; }
            table { font-size: 0.8em; }
            th, td { padding: 4px 6px; }
            .calendar-popup { left: 10px; right: 10px; min-width: auto; }
            .chart-zoom-modal { width: 95vw; height: 85vh; padding: 12px; }
            .journal-hide-mobile { display: none; }
        }
    </style>
</head>
<body>
<div class="app-layout">

<!-- Sidebar -->
<nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <img src="/static/icon.png" alt="DOCSight" style="width:28px;height:28px;border-radius:6px;vertical-align:middle;margin-right:8px;">
        <span>DOCSight</span>
        <button class="sidebar-toggle" id="sidebar-collapse" title="Collapse">&#10094;</button>
    </div>
    <div class="sidebar-content">
        <div class="sidebar-section-label">{{ t.sidebar_monitoring }}</div>
        <a class="sidebar-link active" data-view="live">
            <span class="icon recording-dot">&#9679;</span> {{ t.live_dashboard }}
        </a>
        <a class="sidebar-link" data-view="events">
            <span class="icon">&#128276;</span> {{ t.event_log }}
            <span class="event-badge" id="event-badge" style="display:none;"></span>
        </a>
        <a class="sidebar-link" data-view="trends">
            <span class="icon">&#128202;</span> {{ t.signal_trends }}
        </a>
        <a class="sidebar-link" data-view="channels">
            <span class="icon">&#128202;</span> {{ t.channel_timeline }}
        </a>
        <div class="sidebar-section-label">{{ t.sidebar_external }}</div>
        {% if speedtest_configured %}
        <a class="sidebar-link" data-view="speedtest">
            <span class="icon">&#9889;</span> {{ t.speedtest }}
        </a>
        {% endif %}
        {% if not speedtest_configured %}
        <a class="sidebar-link" onclick="openSpeedtestSetupModal()">
            <span class="icon">&#9881;</span> {{ t.speedtest_setup }}
        </a>
        {% endif %}
        {% if bqm_configured %}
        <a class="sidebar-link" data-view="bqm">
            <span class="icon">&#128225;</span> {{ t.bqm_title }}
        </a>
        {% endif %}
        {% if not bqm_configured %}
        <a class="sidebar-link" onclick="openBqmSetupModal()">
            <span class="icon">&#9881;</span> {{ t.bqm_setup }}
        </a>
        {% endif %}
        <div class="sidebar-section-label">{{ t.sidebar_documentation }}</div>
        <a class="sidebar-link" data-view="journal">
            <span class="icon">&#128203;</span> {{ t.incident_journal }}
        </a>
        <a class="sidebar-link" id="export-link" onclick="exportForLLM()">
            <span class="icon">&#128190;</span> {{ t.export_llm }}
        </a>
        <a class="sidebar-link" id="report-link" onclick="openReportModal()">
            <span class="icon">&#128226;</span> {{ t.incident_report }}
        </a>
        <div style="flex:1;"></div>
        <div class="sidebar-divider"></div>
        <a class="sidebar-link" href="/settings">
            <span class="icon">&#9881;</span> {{ t.settings }}
        </a>
        {% if auth_enabled %}
        <a class="sidebar-link" href="/logout">
            <span class="icon">&#128682;</span> {{ t.logout }}
        </a>
        {% endif %}
        <div style="padding: 8px 20px 12px;">
            <a href="https://github.com/itsDNNS/docsight/releases" target="_blank"
               style="color: var(--muted); font-size: 0.75em; text-decoration: none; opacity: 0.6;"
               onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.6'">{{ version }}</a>
        </div>
    </div>
</nav>
<div class="sidebar-backdrop" id="sidebar-backdrop"></div>

<!-- Main Area -->
<div class="app-main">

<!-- Topbar -->
<div class="topbar">
    <div class="topbar-left">
        <button class="hamburger-btn" id="hamburger" title="Menu">&#9776;</button>
        <span class="topbar-title">DOCSight</span>
    </div>
    <div class="topbar-right">
        <span class="topbar-meta" id="topbar-meta">
            {% if last_update %}{{ t.last_update }}: {{ last_update }} | {{ poll_interval }}s{% endif %}
        </span>
        {% if not historical %}
        <button class="refresh-btn" id="refresh-btn" title="{{ t.refresh }}">&#x1F504;</button>
        {% endif %}
        <select class="lang-select" id="lang-select" title="Language">
            {% for code, name in languages.items() %}
            <option value="{{ code }}" {% if code == lang %}selected{% endif %}>{{ lang_flags.get(code, '') }} {{ code.upper() }}</option>
            {% endfor %}
        </select>
        <button class="theme-toggle" id="theme-toggle" title="Toggle theme">&#9790;</button>
    </div>
</div>

<!-- Calendar Popup -->
<div class="calendar-popup" id="calendar-popup">
    <div class="cal-nav">
        <button id="cal-prev">&lsaquo;</button>
        <span id="cal-month-label"></span>
        <button id="cal-next">&rsaquo;</button>
    </div>
    <div class="cal-weekdays">
        <span>Mo</span><span>Tu</span><span>We</span><span>Th</span><span>Fr</span><span>Sa</span><span>Su</span>
    </div>
    <div class="cal-days" id="cal-days"></div>
</div>

<div class="date-nav" id="date-nav">
    <button id="date-prev">&#8249;</button>
    <span class="date-label" id="date-label" title="{{ t.open_calendar }}">{{ t.live }}</span>
    <button id="date-next">&#8250;</button>
</div>

<!-- ═══ View: Dashboard ═══ -->
<div class="main-content">
<div id="view-dashboard" class="view active">

{% if historical %}
<div class="history-banner">
    {{ t.historical_view }}: {{ snapshot_ts.replace("T", " ") }}
    <a href="/">{{ t.back_to_live }} &rarr;</a>
</div>
{% endif %}

{% if error %}
<div class="error-box">{{ t.error_label }}: {{ error }}</div>
{% endif %}

{% if analysis %}
    {% set s = analysis.summary %}
    {% set ds = analysis.ds_channels %}
    {% set us = analysis.us_channels %}

    {% set health_map = {"good": t.health_good, "marginal": t.health_marginal, "poor": t.health_poor} %}
    {% set health_label = health_map.get(s.health, s.health) %}
    {% set health_msgs = {"good": t.health_good_msg, "marginal": t.health_marginal_msg, "poor": t.health_poor_msg} %}
    {% set issue_labels = {
        "ds_power_critical": t.issue_ds_power_critical,
        "us_power_critical": t.issue_us_power_critical,
        "us_power_warn": t.issue_us_power_warn,
        "snr_critical": t.issue_snr_critical,
        "snr_warn": t.issue_snr_warn,
        "uncorr_errors_high": t.issue_uncorr_errors_high,
    } %}
    {% set issue_descs = {
        "ds_power_critical": t.issue_ds_power_critical_desc,
        "us_power_critical": t.issue_us_power_critical_desc,
        "us_power_warn": t.issue_us_power_warn_desc,
        "snr_critical": t.issue_snr_critical_desc,
        "snr_warn": t.issue_snr_warn_desc,
        "uncorr_errors_high": t.issue_uncorr_errors_high_desc,
    } %}

    <div class="health-banner health-{{ 'good' if s.health == 'good' else ('crit' if s.health == 'poor' else 'warn') }}">
        <div class="health-status">
            <span class="health-icon">{% if s.health == 'good' %}&#10004;{% elif s.health == 'poor' %}&#10006;{% else %}&#9888;{% endif %}</span>
            <span class="health-title">{{ health_label }}</span>
        </div>
        <div class="health-msg">{{ health_msgs.get(s.health, '') }}</div>
        {% if s.health_issues %}
        <div class="health-issues">
            {% for issue in s.health_issues %}
            <div class="health-issue">
                <span class="health-issue-name">{{ issue_labels.get(issue, issue) }}<span class="info-tip"><i class="tip-icon" tabindex="0">&#9432;</i><span class="tip-text">{{ issue_descs.get(issue, '') }}</span></span></span>
                <span class="health-issue-desc">{{ issue_descs.get(issue, '') }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    {# ── Connection Info Bar ── #}
    {% if isp_name or (connection_info and connection_info.max_downstream_kbps) %}
    <div class="conn-info-bar">
        {% if isp_name %}{{ isp_name }}{% endif %}
        {% if connection_info and connection_info.max_downstream_kbps %}
            {% if isp_name %}<span class="conn-sep">&middot;</span>{% endif %}
            {{ connection_info.max_downstream_kbps // 1000 }}/{{ connection_info.max_upstream_kbps // 1000 }} Mbit/s
        {% endif %}
        <span class="conn-sep">|</span>
        {{ s.ds_total }} DS <span class="conn-sep">/</span> {{ s.us_total }} US {{ t.channels|lower }}
    </div>
    {% endif %}

    {# ── Per-card health ── #}
    {% set signal_health = 'crit' if 'ds_power_critical' in s.health_issues or 'snr_critical' in s.health_issues
       else ('warn' if 'ds_power_warn' in s.health_issues or 'snr_warn' in s.health_issues else 'good') %}
    {% set us_health = 'crit' if 'us_power_critical' in s.health_issues
       else ('warn' if 'us_power_warn' in s.health_issues else 'good') %}
    {% set error_health = 'crit' if 'uncorr_errors_high' in s.health_issues else 'good' %}

    {# ── DS Power health ── #}
    {% set ds_pwr_health = 'crit' if 'ds_power_critical' in s.health_issues else ('warn' if 'ds_power_warn' in s.health_issues else 'good') %}
    {# ── SNR health ── #}
    {% set snr_health = 'crit' if 'snr_critical' in s.health_issues else ('warn' if 'snr_warn' in s.health_issues else 'good') %}

    {# ── Range marker positions (clamped 2-98%) ── #}
    {# DS Power: range -12 to +25 = 37 units #}
    {% set ds_pwr_marker = [2, [98, ((s.ds_power_avg + 12) / 37 * 100)|round|int]|min]|max %}
    {% set snr_marker = [2, [98, ((s.ds_snr_avg - 15) / 30 * 100)|round|int]|min]|max %}
    {# US Power: range 30 to 60 = 30 units #}
    {% set us_pwr_marker = [2, [98, ((s.us_power_avg - 30) / 30 * 100)|round|int]|min]|max %}

    <div class="metric-cards">
        {# ── Card 1: Downstream ── #}
        <div class="metric-card health-{{ signal_health }}">
            <div class="metric-card-header" onclick="toggleCard(this.parentNode)">
                <span class="status-dot"></span>
                <span class="card-title">&#8595; {{ t.card_signal_quality }}</span>
                <span class="chevron">&#9654;</span>
            </div>
            <div class="metric-card-body">
                <div class="metric-row">
                    <div class="metric-item">
                        <div class="metric-value val-{{ ds_pwr_health }}">{{ s.ds_power_avg }}<span class="metric-unit">dBmV</span></div>
                        <div class="metric-label">{{ t.card_ds_power }}<span class="info-tip"><i class="tip-icon" tabindex="0">&#9432;</i><span class="tip-text">{{ t.tip_ds_power }}</span></span></div>
                        <div class="range-indicator">
                            <div class="range-zone range-crit" style="width:10.8%"></div>
                            <div class="range-zone range-warn" style="width:10.8%"></div>
                            <div class="range-zone range-good" style="width:45.9%"></div>
                            <div class="range-zone range-warn" style="width:18.9%"></div>
                            <div class="range-zone range-crit" style="width:13.6%"></div>
                            <div class="range-marker val-{{ ds_pwr_health }}" style="left:{{ ds_pwr_marker }}%"></div>
                        </div>
                        <div class="range-labels"><span>-8</span><span>+13</span><span>+20</span></div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value val-{{ snr_health }}">{{ s.ds_snr_avg }}<span class="metric-unit">dB</span></div>
                        <div class="metric-label">{{ t.card_snr }}<span class="info-tip"><i class="tip-icon" tabindex="0">&#9432;</i><span class="tip-text">{{ t.tip_snr }}</span></span></div>
                        <div class="range-indicator">
                            <div class="range-zone range-crit" style="width:33.3%"></div>
                            <div class="range-zone range-warn" style="width:16.7%"></div>
                            <div class="range-zone range-good" style="width:50%"></div>
                            <div class="range-marker val-{{ snr_health }}" style="left:{{ snr_marker }}%"></div>
                        </div>
                        <div class="range-labels"><span>15</span><span>29</span><span>33</span><span>45 dB</span></div>
                    </div>
                </div>
            </div>
            <div class="metric-card-detail">
                <table class="detail-table">
                    <tr><td>{{ t.card_power_range }}</td><td>{{ s.ds_power_min }} ... {{ s.ds_power_max }} dBmV</td></tr>
                    <tr><td>SNR {{ t.card_power_range }}</td><td>{{ s.ds_snr_min }} ... {{ s.ds_snr_avg }} dB</td></tr>
                    <tr><td>{{ t.channels }}</td><td>{{ s.ds_total }} {{ t.downstream|lower }}</td></tr>
                    <tr><td>{{ t.card_ideal_range }}</td><td>-4...+13 dBmV / SNR &gt;33 dB</td></tr>
                </table>
            </div>
        </div>

        {# ── Card 2: Upstream ── #}
        <div class="metric-card health-{{ us_health }}">
            <div class="metric-card-header" onclick="toggleCard(this.parentNode)">
                <span class="status-dot"></span>
                <span class="card-title">&#8593; {{ t.card_upstream }}</span>
                <span class="chevron">&#9654;</span>
            </div>
            <div class="metric-card-body">
                <div class="metric-row">
                    <div class="metric-item">
                        <div class="metric-value val-{{ us_health }}">{{ s.us_power_avg }}<span class="metric-unit">dBmV</span></div>
                        <div class="metric-label">{{ t.card_transmit_power }}<span class="info-tip"><i class="tip-icon" tabindex="0">&#9432;</i><span class="tip-text">{{ t.tip_transmit_power }}</span></span></div>
                        <div class="range-indicator">
                            <div class="range-zone range-crit" style="width:16.7%"></div>
                            <div class="range-zone range-warn" style="width:20%"></div>
                            <div class="range-zone range-good" style="width:20%"></div>
                            <div class="range-zone range-warn" style="width:20%"></div>
                            <div class="range-zone range-crit" style="width:23.3%"></div>
                            <div class="range-marker val-{{ us_health }}" style="left:{{ us_pwr_marker }}%"></div>
                        </div>
                        <div class="range-labels"><span>30</span><span>41</span><span>47</span><span>53</span><span>60</span></div>
                    </div>
                </div>
            </div>
            <div class="metric-card-detail">
                <table class="detail-table">
                    <tr><td>{{ t.card_power_range }}</td><td>{{ s.us_power_min }} ... {{ s.us_power_max }} dBmV</td></tr>
                    <tr><td>{{ t.channels }}</td><td>{{ s.us_total }} {{ t.upstream|lower }}</td></tr>
                    <tr><td>{{ t.card_ideal_range }}</td><td>41 ... 47 dBmV</td></tr>
                </table>
            </div>
        </div>

        {# ── Card 3: Errors ── #}
        <div class="metric-card health-{{ error_health }}">
            <div class="metric-card-header" onclick="toggleCard(this.parentNode)">
                <span class="status-dot"></span>
                <span class="card-title">{{ t.card_errors }}</span>
                <span class="chevron">&#9654;</span>
            </div>
            <div class="metric-card-body">
                <div class="metric-row">
                    <div class="metric-item">
                        <div class="metric-value val-{{ error_health }}">{{ s.ds_uncorrectable_errors|fmt_k }}<span class="metric-unit">{{ t.card_uncorr_label }}<span class="info-tip"><i class="tip-icon" tabindex="0">&#9432;</i><span class="tip-text">{{ t.tip_uncorrectable }}</span></span></span></div>
                        <div class="gauge-bar"><div class="gauge-fill val-{{ error_health }}" style="width:{{ uncorr_pct|int }}%"></div></div>
                        <div class="metric-secondary">{{ s.ds_correctable_errors|fmt_k }} {{ t.card_corr_label }}<span class="info-tip"><i class="tip-icon" tabindex="0">&#9432;</i><span class="tip-text">{{ t.tip_correctable }}</span></span></div>
                    </div>
                </div>
                {% if device_info and device_info.uptime_seconds is defined %}
                {% set ut = device_info.uptime_seconds %}
                {% set ut_d = ut // 86400 %}
                {% set ut_h = (ut % 86400) // 3600 %}
                <div class="metric-secondary" style="margin-top:10px; padding-top:10px; border-top:1px solid var(--input-border);">
                    &#9201; {{ t.card_uptime }}: <strong>{% if ut_d %}{{ ut_d }}d {% endif %}{{ ut_h }}h</strong>
                </div>
                {% endif %}
            </div>
            <div class="metric-card-detail">
                <table class="detail-table">
                    <tr><td>{{ t.card_uncorr_exact }}</td><td>{{ "{:,}".format(s.ds_uncorrectable_errors) }}</td></tr>
                    <tr><td>{{ t.card_corr_exact }}</td><td>{{ "{:,}".format(s.ds_correctable_errors) }}</td></tr>
                </table>
                <div class="detail-note">{{ t.card_errors_note }}</div>
            </div>
        </div>

        {# ── Card 4: Speed (Speedtest Tracker) ── #}
        {% if speedtest_configured and speedtest_latest %}
        {# Compute speed health based on booked speed: >=80% good, 50-80% warn, <50% crit #}
        {# Use booked speed from settings, fall back to Fritz!Box connection_info #}
        {% set eff_booked_dl = booked_download if (booked_download and booked_download > 0) else ((connection_info.max_downstream_kbps // 1000) if connection_info and connection_info.max_downstream_kbps else 0) %}
        {% set eff_booked_ul = booked_upload if (booked_upload and booked_upload > 0) else ((connection_info.max_upstream_kbps // 1000) if connection_info and connection_info.max_upstream_kbps else 0) %}
        {% if eff_booked_dl > 0 %}
            {% set dl_ratio = speedtest_latest.download_mbps / eff_booked_dl %}
            {% if dl_ratio >= 0.8 %}
                {% set speed_health = 'health-good' %}
                {% set dl_val_class = 'val-good' %}
            {% elif dl_ratio >= 0.5 %}
                {% set speed_health = 'health-warn' %}
                {% set dl_val_class = 'val-warn' %}
            {% else %}
                {% set speed_health = 'health-crit' %}
                {% set dl_val_class = 'val-bad' %}
            {% endif %}
        {% else %}
            {% set speed_health = 'health-good' %}
            {% set dl_val_class = 'val-good' %}
        {% endif %}
        {% if eff_booked_ul > 0 %}
            {% set ul_ratio = speedtest_latest.upload_mbps / eff_booked_ul %}
            {% if ul_ratio >= 0.8 %}
                {% set ul_val_class = 'val-good' %}
            {% elif ul_ratio >= 0.5 %}
                {% set ul_val_class = 'val-warn' %}
            {% else %}
                {% set ul_val_class = 'val-bad' %}
            {% endif %}
        {% else %}
            {% set ul_val_class = 'val-good' %}
        {% endif %}
        <div class="metric-card {{ speed_health }}">
            <div class="metric-card-header" onclick="toggleCard(this.parentNode)">
                <span class="status-dot"></span>
                <span class="card-title">&#9889; {{ t.speed }}</span>
                <span class="chevron">&#9654;</span>
            </div>
            <div class="metric-card-body">
                <div class="metric-row">
                    <div class="metric-item">
                        <div class="metric-value {{ dl_val_class }}">{{ speedtest_latest.download_human or (speedtest_latest.download_mbps ~ ' Mbps') }}</div>
                        <div class="metric-label">{{ t.download }}<span class="info-tip"><i class="tip-icon" tabindex="0">&#9432;</i><span class="tip-text">{{ t.tip_download }}</span></span></div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value {{ ul_val_class }}">{{ speedtest_latest.upload_human or (speedtest_latest.upload_mbps ~ ' Mbps') }}</div>
                        <div class="metric-label">{{ t.upload }}<span class="info-tip"><i class="tip-icon" tabindex="0">&#9432;</i><span class="tip-text">{{ t.tip_upload }}</span></span></div>
                    </div>
                </div>
                <div class="metric-secondary" style="margin-top:8px;">
                    {{ t.ping }}: <strong>{{ speedtest_latest.ping_ms }} ms</strong>
                    <span class="conn-sep">&middot;</span>
                    {{ t.jitter }}: <strong>{{ speedtest_latest.jitter_ms }} ms</strong>
                    {% if speedtest_latest.packet_loss_pct > 0 %}
                    <span class="conn-sep">&middot;</span>
                    <span class="val-warn">{{ t.packet_loss }}: {{ speedtest_latest.packet_loss_pct }}%</span>
                    {% endif %}
                </div>
            </div>
            <div class="metric-card-detail">
                <table class="detail-table">
                    <tr><td>{{ t.download }}</td><td>{{ speedtest_latest.download_mbps }} Mbps</td></tr>
                    <tr><td>{{ t.upload }}</td><td>{{ speedtest_latest.upload_mbps }} Mbps</td></tr>
                    <tr><td>{{ t.ping }}</td><td>{{ speedtest_latest.ping_ms }} ms</td></tr>
                    <tr><td>{{ t.jitter }}</td><td>{{ speedtest_latest.jitter_ms }} ms</td></tr>
                    <tr><td>{{ t.packet_loss }}</td><td>{{ speedtest_latest.packet_loss_pct }}%</td></tr>
                </table>
                <div class="detail-note">{{ t.via_speedtest_tracker }}{% if speedtest_latest.timestamp %} &middot; {{ speedtest_latest.timestamp }}{% endif %}</div>
            </div>
        </div>
        {% endif %}
    </div>

    <h2 class="section-title">{{ t.downstream }} ({{ ds|length }} {{ t.channels }})</h2>
    {% for group in ds|groupby('docsis_version')|reverse %}
    {% set g_crit = group.list|selectattr('health', 'equalto', 'critical')|list|length %}
    {% set g_warn = group.list|rejectattr('health', 'equalto', 'good')|rejectattr('health', 'equalto', 'critical')|list|length %}
    <details class="channel-group">
        <summary>DOCSIS {{ group.grouper }} ({{ group.list|length }} {{ t.channels }}) {% if g_crit %}<span class="badge badge-crit">{{ g_crit }} {{ t.health_critical|lower }}</span>{% elif g_warn %}<span class="badge badge-warn">{{ g_warn }} {{ t.health_warning|lower }}</span>{% else %}<span class="badge badge-good">&#10003;</span>{% endif %}</summary>
        <table class="sortable">
            <thead><tr>
                <th>{{ t.status }}</th><th>{{ t.channel }}</th><th>{{ t.frequency }}</th><th>{{ t.power_dbmv }}</th>
                <th>{{ t.snr_db }}</th><th>{{ t.modulation }}</th><th>{{ t.corr }}</th><th>{{ t.uncorr }}</th>
            </tr></thead>
            <tbody>
            {% for ch in group.list %}
            <tr>
                {% set ch_tips = {"power critical": t.ch_power_critical, "power warning": t.ch_power_warning, "snr critical": t.ch_snr_critical, "snr warning": t.ch_snr_warning} %}
                {% set ch_tip_parts = [] %}
                {% for key, label in ch_tips.items() %}{% if key in ch.health_detail %}{% if ch_tip_parts.append(label) %}{% endif %}{% endif %}{% endfor %}
                <td data-sort="{{ 0 if ch.health == 'good' else (2 if ch.health == 'critical' else 1) }}">
                    {% if ch.health == "good" %}<span class="badge badge-good">{{ t.health_good }}</span>
                    {% elif ch.health == "critical" %}<span class="badge badge-crit" title="{{ ch_tip_parts|join(', ') }}">{{ t.health_critical }}</span>
                    {% else %}<span class="badge badge-warn" title="{{ ch_tip_parts|join(', ') }}">{{ t.health_warning }}</span>{% endif %}
                </td>
                <td data-sort="{{ ch.channel_id }}">{{ ch.channel_id }}</td>
                <td>{{ ch.frequency }}</td>
                <td data-sort="{{ ch.power if ch.power is not none else 0 }}" class="{% if ch.power is not none %}{% if ch.power < -8 or ch.power > 20 %}val-crit{% elif ch.power < -4 or ch.power > 13 %}val-warn{% else %}val-good{% endif %}{% endif %}">{{ ch.power }}</td>
                <td data-sort="{{ ch.snr if ch.snr is not none else 0 }}" class="{% if ch.snr is not none %}{% if ch.snr < 29 %}val-crit{% elif ch.snr < 33 %}val-warn{% else %}val-good{% endif %}{% endif %}">{{ ch.snr if ch.snr is not none else "-" }}</td>
                <td>{{ ch.modulation }}</td>
                <td data-sort="{{ ch.correctable_errors }}">{{ ch.correctable_errors|fmt_k }}</td>
                <td data-sort="{{ ch.uncorrectable_errors }}">{{ ch.uncorrectable_errors|fmt_k }}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </details>
    {% endfor %}

    <h2 class="section-title">{{ t.upstream }} ({{ us|length }} {{ t.channels }})</h2>
    {% for group in us|groupby('docsis_version')|reverse %}
    {% set g_crit = group.list|selectattr('health', 'equalto', 'critical')|list|length %}
    {% set g_warn = group.list|rejectattr('health', 'equalto', 'good')|rejectattr('health', 'equalto', 'critical')|list|length %}
    <details class="channel-group">
        <summary>DOCSIS {{ group.grouper }} ({{ group.list|length }} {{ t.channels }}) {% if g_crit %}<span class="badge badge-crit">{{ g_crit }} {{ t.health_critical|lower }}</span>{% elif g_warn %}<span class="badge badge-warn">{{ g_warn }} {{ t.health_warning|lower }}</span>{% else %}<span class="badge badge-good">&#10003;</span>{% endif %}</summary>
        <table class="sortable">
            <thead><tr>
                <th>{{ t.status }}</th><th>{{ t.channel }}</th><th>{{ t.frequency }}</th><th>{{ t.power_dbmv }}</th>
                <th>{{ t.modulation }}</th><th>{{ t.multiplex }}</th>
            </tr></thead>
            <tbody>
            {% for ch in group.list %}
            {% set ch_tip = t.ch_power_critical if 'power critical' in ch.health_detail else (t.ch_power_warning if 'power warning' in ch.health_detail else '') %}
            <tr>
                <td data-sort="{{ 0 if ch.health == 'good' else (2 if ch.health == 'critical' else 1) }}">
                    {% if ch.health == "good" %}<span class="badge badge-good">{{ t.health_good }}</span>
                    {% elif ch.health == "critical" %}<span class="badge badge-crit" title="{{ ch_tip }}">{{ t.health_critical }}</span>
                    {% else %}<span class="badge badge-warn" title="{{ ch_tip }}">{{ t.health_warning }}</span>{% endif %}
                </td>
                <td data-sort="{{ ch.channel_id }}">{{ ch.channel_id }}</td>
                <td>{{ ch.frequency }}</td>
                <td data-sort="{{ ch.power }}" class="{% if ch.power < 35 or ch.power > 53 %}val-crit{% elif ch.power < 41 or ch.power > 47 %}val-warn{% else %}val-good{% endif %}">{{ ch.power }}</td>
                <td>{{ ch.modulation }}</td>
                <td>{{ ch.multiplex }}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </details>
    {% endfor %}
    {% if not has_us_ofdma %}
    <div class="card-notice card-notice-warn" style="margin-top:8px;">
        <span>&#9888;</span> {{ t.card_no_docsis31 }}
    </div>
    {% endif %}

{% elif not error %}
    <div class="waiting">
        <div class="spinner"></div>
        <p>{{ t.waiting_msg }}</p>
    </div>
{% endif %}
</div>

<!-- ═══ View: Trends ═══ -->
<div id="view-trends" class="view">
    <div class="trend-header">
        <span class="trend-title" id="trend-title"></span>
        <div class="trend-tabs" id="trend-tabs">
            <button class="trend-tab active" data-range="day">{{ t.day }}</button>
            <button class="trend-tab" data-range="week">{{ t.week }}</button>
            <button class="trend-tab" data-range="month">{{ t.month }}</button>
        </div>
    </div>
    <div id="trend-no-data" class="no-data-msg" style="display:none"></div>
    <div class="charts-grid" id="charts-grid">
        <div class="chart-card">
            <button class="chart-expand-btn" data-chart="chart-ds-power" title="Expand">&#x26F6;</button>
            <div class="chart-label">{{ t.ds_power_avg }}</div>
            <canvas id="chart-ds-power"></canvas>
        </div>
        <div class="chart-card">
            <button class="chart-expand-btn" data-chart="chart-ds-snr" title="Expand">&#x26F6;</button>
            <div class="chart-label">{{ t.ds_snr_avg }}</div>
            <canvas id="chart-ds-snr"></canvas>
        </div>
        <div class="chart-card">
            <button class="chart-expand-btn" data-chart="chart-us-power" title="Expand">&#x26F6;</button>
            <div class="chart-label">{{ t.us_power_avg }}</div>
            <canvas id="chart-us-power"></canvas>
        </div>
        <div class="chart-card">
            <button class="chart-expand-btn" data-chart="chart-errors" title="Expand">&#x26F6;</button>
            <div class="chart-label">{{ t.errors }}</div>
            <canvas id="chart-errors"></canvas>
        </div>
    </div>
</div>

<!-- ═══ View: BQM Graphs ═══ -->
{% if bqm_configured %}
<div id="view-bqm" class="view">
    <div class="trend-header">
        <span class="trend-title">{{ t.bqm_title }}</span>
    </div>
    <div id="bqm-content">
        <div id="bqm-image-wrap" style="text-align:center;">
            <img id="bqm-image" style="max-width:100%; border-radius:8px; display:none;" alt="BQM Graph">
        </div>
        <div id="bqm-no-data" class="no-data-msg" style="display:none;"></div>
    </div>
</div>
{% endif %}

<!-- ═══ View: Incident Journal ═══ -->
<div id="view-journal" class="view">
    <div class="journal-header">
        <span class="trend-title">{{ t.incident_journal }}</span>
        <button class="btn-new-entry" onclick="openIncidentModal()">+ {{ t.new_entry }}</button>
    </div>
    <div id="journal-loading" class="waiting" style="display:none;">
        <div class="spinner"></div>
    </div>
    <div id="journal-empty" class="journal-empty" style="display:none;"></div>
    <table id="journal-table" style="display:none;">
        <thead><tr>
            <th data-col="date">{{ t.incident_date }}<span class="sort-indicator"></span></th>
            <th data-col="title">{{ t.incident_title }}<span class="sort-indicator"></span></th>
            <th data-col="description" class="journal-hide-mobile">{{ t.incident_description }}<span class="sort-indicator"></span></th>
            <th>&#128206;</th>
        </tr></thead>
        <tbody id="journal-tbody"></tbody>
    </table>
</div>

<!-- ═══ View: Event Log ═══ -->
<div id="view-events" class="view">
    <div class="events-header">
        <span class="trend-title">{{ t.event_log }}</span>
        <button class="btn-ack-all" id="btn-ack-all" onclick="acknowledgeAllEvents()" style="display:none;">&#10003; {{ t.event_acknowledge_all }}</button>
    </div>
    <div class="events-filters">
        <select id="events-filter-severity" onchange="loadEvents()">
            <option value="">{{ t.event_all_severities }}</option>
            <option value="info">{{ t.event_severity_info }}</option>
            <option value="warning">{{ t.event_severity_warning }}</option>
            <option value="critical">{{ t.event_severity_critical }}</option>
        </select>
        <select id="events-filter-type" onchange="loadEvents()">
            <option value="">{{ t.event_all_types }}</option>
            <option value="health_change">{{ t.event_type_health_change }}</option>
            <option value="power_change">{{ t.event_type_power_change }}</option>
            <option value="snr_change">{{ t.event_type_snr_change }}</option>
            <option value="channel_change">{{ t.event_type_channel_change }}</option>
            <option value="modulation_change">{{ t.event_type_modulation_change }}</option>
            <option value="error_spike">{{ t.event_type_error_spike }}</option>
        </select>
    </div>
    <div id="events-loading" class="waiting" style="display:none;">
        <div class="spinner"></div>
    </div>
    <div id="events-empty" class="events-empty" style="display:none;"></div>
    <table id="events-table" style="display:none;">
        <thead><tr>
            <th>{{ t.timestamp }}</th>
            <th>{{ t.event_severity }}</th>
            <th>{{ t.event_type }}</th>
            <th>{{ t.event_message }}</th>
            <th></th>
        </tr></thead>
        <tbody id="events-tbody"></tbody>
    </table>
    <div id="events-show-more" style="text-align:center; padding:16px; display:none;">
        <button class="btn-ack-all" onclick="loadMoreEvents()">{{ t.show_more }}</button>
    </div>
</div>

<!-- ═══ View: Channel Timeline ═══ -->
<div id="view-channels" class="view">
    <div class="events-header">
        <span class="trend-title">{{ t.channel_timeline }}</span>
    </div>
    <div class="events-filters">
        <select id="channel-select" onchange="loadChannelTimeline()">
            <option value="">{{ t.select_channel }}</option>
        </select>
        <select id="channel-time-range" onchange="loadChannelTimeline()">
            <option value="1">1 {{ t.day }}</option>
            <option value="3">3 {{ t.day }}</option>
            <option value="7" selected>7 {{ t.day }}</option>
            <option value="30">30 {{ t.day }}</option>
        </select>
    </div>
    <div id="channel-loading" class="waiting" style="display:none;">
        <div class="spinner"></div>
    </div>
    <div id="channel-empty" class="events-empty" style="display:none;"></div>
    <div id="channel-charts" class="charts-grid" style="display:none;">
        <div class="chart-card">
            <button class="chart-expand-btn" data-chart="chart-ch-power" title="Expand">&#x26F6;</button>
            <div class="chart-label">{{ t.power_history }}</div>
            <canvas id="chart-ch-power"></canvas>
        </div>
        <div class="chart-card">
            <button class="chart-expand-btn" data-chart="chart-ch-errors" title="Expand">&#x26F6;</button>
            <div class="chart-label">{{ t.error_history }}</div>
            <canvas id="chart-ch-errors"></canvas>
        </div>
        <div class="chart-card" id="channel-modulation-card" style="grid-column:1/-1;">
            <div class="chart-label">{{ t.modulation }}</div>
            <div id="channel-modulation-badges" class="mod-timeline"></div>
        </div>
    </div>
</div>

<!-- ═══ Incident Modal ═══ -->
<div class="modal-overlay" id="incident-modal" onclick="if(event.target===this)closeIncidentModal()">
    <div class="modal" style="max-width:640px;">
        <div class="modal-header">
            <h2 id="incident-modal-title"></h2>
            <button class="modal-close" onclick="closeIncidentModal()">&times;</button>
        </div>
        <div class="modal-body" style="overflow-y:auto;">
            <input type="hidden" id="incident-id">
            <div class="incident-form-group">
                <label for="incident-date">{{ t.incident_date }}</label>
                <input type="date" id="incident-date">
            </div>
            <div class="incident-form-group">
                <label for="incident-title-input">{{ t.incident_title }}</label>
                <input type="text" id="incident-title-input" maxlength="200" placeholder="{{ t.incident_title }}">
            </div>
            <div class="incident-form-group">
                <label for="incident-desc">{{ t.incident_description }}</label>
                <textarea id="incident-desc" maxlength="10000" placeholder="{{ t.incident_description }}"></textarea>
            </div>
            <div class="incident-form-group" id="incident-attachments-section">
                <label>{{ t.attachments }}</label>
                <div class="attachment-list" id="incident-attachment-list"></div>
                <button class="btn-upload" id="incident-upload-btn" onclick="document.getElementById('incident-file-input').click()">
                    &#128206; {{ t.upload_file }}
                </button>
                <span id="incident-upload-spinner" style="display:none;"><span class="upload-spinner"></span></span>
                <input type="file" id="incident-file-input" style="display:none;" multiple
                       accept="image/png,image/jpeg,image/gif,image/webp,application/pdf,text/plain"
                       onchange="handleIncidentFileUpload(this)">
            </div>
        </div>
        <div class="incident-modal-footer">
            <div class="modal-footer-left">
                <button class="btn-danger" id="incident-delete-btn" onclick="deleteIncident()" style="display:none;">{{ t.delete_incident }}</button>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-muted" onclick="closeIncidentModal()">{{ t.cancel }}</button>
                <button class="btn btn-accent" onclick="saveIncident()">{{ t.save }}</button>
            </div>
        </div>
    </div>
</div>

<!-- ═══ View: Speedtest ═══ -->
{% if speedtest_configured %}
<div id="view-speedtest" class="view">
    <div class="trend-header">
        <span class="trend-title">{{ t.speedtest_tracker }}</span>
        <div style="display:flex; gap:8px; align-items:center;">
            <select id="speedtest-days" style="padding:6px 10px; border-radius:6px; border:1px solid var(--input-border); background:var(--surface); color:var(--text);" onchange="filterSpeedtestData()">
                <option value="1">1 {{ t.day }}</option>
                <option value="7" selected>7 {{ t.day }}</option>
                <option value="14">14 {{ t.day }}</option>
                <option value="30">30 {{ t.day }}</option>
                <option value="90">90 {{ t.day }}</option>
                <option value="all">{{ t.fetch_all }}</option>
            </select>
            <button class="refresh-btn" id="speedtest-refresh-btn" title="{{ t.refresh }}" onclick="loadSpeedtestHistory()">&#x1F504;</button>
        </div>
    </div>
    <div id="speedtest-loading" class="waiting" style="display:none;">
        <div class="spinner"></div>
        <p>{{ t.fetching }}</p>
    </div>
    <div id="speedtest-no-data" class="no-data-msg" style="display:none;"></div>
    <div id="speedtest-chart-container" style="display:none;">
        <div class="speedtest-chart-wrap">
            <canvas id="speedtest-chart"></canvas>
            <div class="speedtest-chart-tooltip" id="speedtest-chart-tooltip"></div>
            <div class="speedtest-chart-legend">
                <span class="legend-dl">Download (Mbps)</span>
                <span class="legend-ul">Upload (Mbps)</span>
                <span class="legend-ping">Ping (ms)</span>
                <span class="legend-thresh">80% Median DL</span>
            </div>
        </div>
    </div>
    <div id="speedtest-table-wrap">
        <table id="speedtest-table" class="sortable" style="display:none;">
            <thead><tr>
                <th class="st-expand-col"></th>
                <th data-col="timestamp">{{ t.timestamp }}<span class="sort-indicator">▼</span></th>
                <th data-col="download_mbps">{{ t.download }}<span class="sort-indicator"></span></th>
                <th data-col="upload_mbps">{{ t.upload }}<span class="sort-indicator"></span></th>
                <th data-col="ping_ms">{{ t.ping }}<span class="sort-indicator"></span></th>
                <th data-col="jitter_ms">{{ t.jitter }}<span class="sort-indicator"></span></th>
                <th data-col="packet_loss_pct">{{ t.packet_loss }}<span class="sort-indicator"></span></th>
            </tr></thead>
            <tbody id="speedtest-tbody"></tbody>
        </table>
        <div id="speedtest-show-more" style="text-align:center; padding:12px; display:none;">
            <button class="btn btn-muted" id="speedtest-more-btn" onclick="showMoreSpeedtest()"></button>
        </div>
    </div>
</div>
{% endif %}
</div><!-- /main-content -->
</div><!-- /app-main -->
</div><!-- /app-layout -->

<!-- Speedtest Setup Modal -->
<div class="modal-overlay" id="speedtest-setup-modal" onclick="if(event.target===this)closeSpeedtestSetupModal()">
    <div class="modal">
        <div class="modal-header">
            <h2>&#9889; {{ t.speedtest_setup_title }}</h2>
            <button class="modal-close" onclick="closeSpeedtestSetupModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding: 10px 0; font-size: 0.9em; line-height: 1.6;">
            <p style="margin-bottom:12px;">{{ t.speedtest_setup_intro }}</p>
            <div style="background:var(--bg); border-radius:8px; padding:14px; margin-bottom:14px;">
                <p style="font-weight:bold; margin-bottom:8px; color:var(--accent);">{{ t.speedtest_setup_benefits_title }}</p>
                <ul style="list-style:none; padding:0;">
                    <li style="margin-bottom:6px;">&#10003; {{ t.speedtest_setup_benefit_1 }}</li>
                    <li style="margin-bottom:6px;">&#10003; {{ t.speedtest_setup_benefit_2 }}</li>
                    <li style="margin-bottom:6px;">&#10003; {{ t.speedtest_setup_benefit_3 }}</li>
                </ul>
            </div>
            <div style="background:var(--bg); border-radius:8px; padding:14px;">
                <p style="font-weight:bold; margin-bottom:8px; color:var(--accent);">{{ t.speedtest_setup_howto_title }}</p>
                <ol style="padding-left:20px;">
                    <li style="margin-bottom:6px;">{{ t.speedtest_setup_step_1|safe }}</li>
                    <li style="margin-bottom:6px;">{{ t.speedtest_setup_step_2|safe }}</li>
                    <li style="margin-bottom:6px;">{{ t.speedtest_setup_step_3|safe }}</li>
                </ol>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-muted" onclick="closeSpeedtestSetupModal()">{{ t.close }}</button>
            <a class="btn btn-accent" href="/settings" style="text-decoration:none;">&#9881; {{ t.settings }}</a>
        </div>
    </div>
</div>

<!-- BQM Setup Modal -->
<div class="modal-overlay" id="bqm-setup-modal" onclick="if(event.target===this)closeBqmSetupModal()">
    <div class="modal">
        <div class="modal-header">
            <h2>&#128200; {{ t.bqm_setup_title }}</h2>
            <button class="modal-close" onclick="closeBqmSetupModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding: 10px 0; font-size: 0.9em; line-height: 1.6;">
            <p style="margin-bottom:12px;">{{ t.bqm_setup_intro }}</p>
            <div style="background:var(--bg); border-radius:8px; padding:14px; margin-bottom:14px;">
                <p style="font-weight:bold; margin-bottom:8px; color:var(--accent);">{{ t.bqm_setup_benefits_title }}</p>
                <ul style="list-style:none; padding:0;">
                    <li style="margin-bottom:6px;">✅ {{ t.bqm_setup_benefit_1 }}</li>
                    <li style="margin-bottom:6px;">✅ {{ t.bqm_setup_benefit_2 }}</li>
                    <li style="margin-bottom:6px;">✅ {{ t.bqm_setup_benefit_3 }}</li>
                </ul>
            </div>
            <div style="background:var(--bg); border-radius:8px; padding:14px;">
                <p style="font-weight:bold; margin-bottom:8px; color:var(--accent);">{{ t.bqm_setup_howto_title }}</p>
                <ol style="padding-left:20px;">
                    <li style="margin-bottom:6px;">{{ t.bqm_setup_step_1|safe }}</li>
                    <li style="margin-bottom:6px;">{{ t.bqm_setup_step_2|safe }}</li>
                    <li style="margin-bottom:6px;">{{ t.bqm_setup_step_3|safe }}</li>
                    <li style="margin-bottom:6px;">{{ t.bqm_setup_step_4|safe }}</li>
                </ol>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-muted" onclick="closeBqmSetupModal()">{{ t.close }}</button>
            <a class="btn btn-accent" href="/settings" style="text-decoration:none;">&#9881; {{ t.settings }}</a>
        </div>
    </div>
</div>

<!-- Report Modal -->
<div class="modal-overlay" id="report-modal" onclick="if(event.target===this)closeReportModal()">
    <div class="modal" style="max-width:800px;">
        <div class="modal-header">
            <h2>{{ t.incident_report }}</h2>
            <button class="modal-close" onclick="closeReportModal()">&times;</button>
        </div>
        <p class="modal-hint">{{ t.report_description }}</p>
        <div class="modal-body" style="padding: 10px 0;">
            <!-- Step 1: Settings & Customer Info -->
            <div id="report-step1">
                <div style="display:flex; gap:16px; flex-wrap:wrap; margin-bottom:14px;">
                    <div>
                        <label style="font-size:13px; color:var(--muted);">{{ t.report_days }}</label><br>
                        <select id="report-days" style="margin-top:4px; padding:6px 10px; border-radius:6px; border:1px solid var(--border); background:var(--bg); color:var(--text);">
                            <option value="1">1</option><option value="3">3</option>
                            <option value="7" selected>7</option><option value="14">14</option>
                            <option value="30">30</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:13px; color:var(--muted);">{{ t.report_language }}</label><br>
                        <select id="report-lang" style="margin-top:4px; padding:6px 10px; border-radius:6px; border:1px solid var(--border); background:var(--bg); color:var(--text);">
                            {% for code, name in languages.items() %}
                            <option value="{{ code }}" {% if code == lang %}selected{% endif %}>{{ lang_flags.get(code, '') }} {{ name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div style="background:var(--bg); border-radius:8px; padding:14px; margin-bottom:10px;">
                    <p style="font-size:13px; color:var(--muted); margin-bottom:10px;">{{ t.report_customer_hint }}</p>
                    <div style="display:flex; flex-direction:column; gap:8px;">
                        <input id="report-name" type="text" placeholder="{{ t.report_name }}" style="padding:8px 12px; border-radius:6px; border:1px solid var(--border); background:var(--surface); color:var(--text); font-family:inherit;">
                        <input id="report-number" type="text" placeholder="{{ t.report_customer_number }}" style="padding:8px 12px; border-radius:6px; border:1px solid var(--border); background:var(--surface); color:var(--text); font-family:inherit;">
                        <input id="report-address" type="text" placeholder="{{ t.report_address }}" style="padding:8px 12px; border-radius:6px; border:1px solid var(--border); background:var(--surface); color:var(--text); font-family:inherit;">
                    </div>
                </div>
            </div>
            <!-- Step 2: Generated complaint text (hidden initially) -->
            <div id="report-step2" style="display:none;">
                <p style="font-size:13px; color:var(--muted); margin-bottom:8px;">{{ t.report_edit_hint }}</p>
                <textarea id="report-complaint-text" style="width:100%; min-height:320px; background:var(--bg); color:var(--text); border:1px solid var(--border); border-radius:6px; padding:12px; font-size:0.85em; font-family:'Consolas','Monaco',monospace; resize:vertical; line-height:1.5;"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-muted" onclick="closeReportModal()">{{ t.close }}</button>
            <button class="btn btn-accent" id="report-generate-btn" onclick="generateComplaint()">&#9998; {{ t.report_generate_letter }}</button>
            <button class="btn btn-accent" id="report-copy-btn" style="display:none;" onclick="copyComplaint()">&#128203; {{ t.report_copy_letter }}</button>
            <button class="btn btn-accent" id="report-pdf-btn" style="display:none;" onclick="downloadReport()">&#128196; {{ t.report_download_pdf }}</button>
        </div>
    </div>
</div>

<!-- Chart Zoom Modal -->
<div class="chart-zoom-overlay" id="chart-zoom-overlay" onclick="if(event.target===this)closeChartZoom()">
    <div class="chart-zoom-modal">
        <div class="modal-header">
            <h2 id="chart-zoom-title"></h2>
            <button class="modal-close" onclick="closeChartZoom()">&times;</button>
        </div>
        <canvas id="chart-zoom-canvas"></canvas>
    </div>
</div>

<!-- Changelog Modal -->
{% if changelog %}
<div class="modal-overlay" id="changelog-modal" onclick="if(event.target===this)closeChangelogModal()">
    <div class="modal" style="max-width:480px;">
        <div class="modal-header">
            <h2>&#127881; {{ t.whats_new }}</h2>
            <button class="modal-close" onclick="closeChangelogModal()">&times;</button>
        </div>
        <p style="color:var(--muted);margin:0 0 12px;font-size:0.85em;">{{ changelog.version }} &middot; {{ changelog.date }}</p>
        <div class="modal-body" style="overflow-y:auto;">
            <ul style="list-style:none;padding:0;margin:0;">
            {% for h in changelog.highlights %}
                <li style="padding:8px 0;border-bottom:1px solid var(--input-border);font-size:0.92em;">{{ h.icon }} {{ h.text }}</li>
            {% endfor %}
            </ul>
        </div>
        <div class="modal-footer" style="flex-direction:column;align-items:stretch;gap:8px;">
            <button class="btn btn-accent" onclick="closeChangelogModal()" style="width:100%;">{{ t.got_it }}</button>
            <a href="https://github.com/itsDNNS/docsight/releases" target="_blank" style="text-align:center;color:var(--muted);font-size:0.8em;text-decoration:none;">{{ t.full_changelog }} &rarr;</a>
        </div>
    </div>
</div>
{% endif %}

<!-- Export Modal -->
<div class="modal-overlay" id="export-modal">
    <div class="modal">
        <div class="modal-header">
            <h2>{{ t.export_title }}</h2>
            <button class="modal-close" onclick="closeExportModal()">&times;</button>
        </div>
        <p class="modal-hint">{{ t.export_hint }}</p>
        <div class="modal-body">
            <textarea id="export-text" readonly></textarea>
        </div>
        <div class="modal-footer">
            <button class="btn btn-muted" onclick="closeExportModal()">{{ t.close }}</button>
            <button class="btn btn-accent" id="export-copy-btn" onclick="copyExport()">{{ t.copy_clipboard }}</button>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<script>
(function() {
    'use strict';

    var T = {{ t|tojson }};

    /* ── Theme ── */
    var saved = localStorage.getItem('docsis-theme');
    if (saved) document.documentElement.setAttribute('data-theme', saved);

    var themeBtn = document.getElementById('theme-toggle');
    function updateThemeIcon() {
        var isDark = document.documentElement.getAttribute('data-theme') !== 'light';
        themeBtn.innerHTML = isDark ? '&#9788;' : '&#9790;';
    }
    updateThemeIcon();
    themeBtn.addEventListener('click', function() {
        var isDark = document.documentElement.getAttribute('data-theme') !== 'light';
        var next = isDark ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('docsis-theme', next);
        updateThemeIcon();
    });

    document.getElementById('lang-select').addEventListener('change', function() {
        var url = new URL(window.location);
        url.searchParams.set('lang', this.value);
        window.location.href = url.toString();
    });

    /* ── State ── */
    var currentView = 'live';
    var selectedDate = todayStr();
    var calendarMonth = new Date();
    var datesWithData = [];
    var charts = {};
    var calendarLoaded = false;
    var _trendRange = 'day';
    var isHistorical = {{ 'true' if historical else 'false' }};

    function todayStr() {
        var d = new Date();
        return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate());
    }
    function pad(n) { return n < 10 ? '0' + n : '' + n; }
    function formatDateDE(str) {
        var p = str.split('-');
        return p[2] + '.' + p[1] + '.' + p[0];
    }

    /* ── Sortable Tables ── */
    function initSortableTables() {
        document.querySelectorAll('table.sortable').forEach(function(table) {
            var headers = table.querySelectorAll('th');
            headers.forEach(function(th, colIdx) {
                th.addEventListener('click', function() {
                    sortTable(table, colIdx, th);
                });
            });
        });
    }
    initSortableTables();

    function sortTable(table, colIdx, th) {
        var tbody = table.querySelector('tbody');
        var rows = Array.from(tbody.querySelectorAll('tr'));
        var asc = th.getAttribute('data-sort-dir') !== 'asc';

        table.querySelectorAll('th').forEach(function(h) {
            h.removeAttribute('data-sort-dir');
            h.classList.remove('sort-asc', 'sort-desc');
        });
        th.setAttribute('data-sort-dir', asc ? 'asc' : 'desc');
        th.classList.add(asc ? 'sort-asc' : 'sort-desc');

        rows.sort(function(a, b) {
            var cellA = a.cells[colIdx];
            var cellB = b.cells[colIdx];
            var valA = cellA.getAttribute('data-sort') || cellA.textContent.trim();
            var valB = cellB.getAttribute('data-sort') || cellB.textContent.trim();
            var numA = parseFloat(valA);
            var numB = parseFloat(valB);
            if (!isNaN(numA) && !isNaN(numB)) {
                return asc ? numA - numB : numB - numA;
            }
            return asc ? valA.localeCompare(valB) : valB.localeCompare(valA);
        });
        rows.forEach(function(row) { tbody.appendChild(row); });
    }

    /* ── Sidebar ── */
    var sidebar = document.getElementById('sidebar');
    var sidebarBackdrop = document.getElementById('sidebar-backdrop');

    function isMobile() { return window.matchMedia('(max-width: 900px)').matches; }

    function collapseSidebar() {
        sidebar.classList.add('collapsed');
        sidebar.classList.remove('mobile-open');
        sidebarBackdrop.classList.remove('active');
    }
    function expandSidebar() {
        sidebar.classList.remove('collapsed');
    }

    document.getElementById('sidebar-collapse').addEventListener('click', collapseSidebar);
    document.getElementById('hamburger').addEventListener('click', function() {
        if (isMobile()) {
            var opening = !sidebar.classList.contains('mobile-open');
            sidebar.classList.toggle('mobile-open', opening);
            sidebarBackdrop.classList.toggle('active', opening);
        } else {
            sidebar.classList.toggle('collapsed');
        }
    });
    sidebarBackdrop.addEventListener('click', collapseSidebar);

    var sidebarLinks = document.querySelectorAll('.sidebar-link[data-view]');
    sidebarLinks.forEach(function(link) {
        link.addEventListener('click', function() {
            if (isMobile()) { collapseSidebar(); }
            switchView(this.getAttribute('data-view'));
        });
    });

    function switchView(view, skipHash) {
        currentView = view;
        if (!skipHash) location.hash = view === 'live' ? '' : view;
        sidebarLinks.forEach(function(l) {
            l.classList.toggle('active', l.getAttribute('data-view') === view);
        });
        var showDateNav = (view === 'live' || view === 'bqm');
        document.getElementById('date-nav').style.display = showDateNav ? 'flex' : 'none';
        var dashView = document.getElementById('view-dashboard');
        var trendView = document.getElementById('view-trends');
        var bqmView = document.getElementById('view-bqm');
        var speedtestView = document.getElementById('view-speedtest');
        var journalView = document.getElementById('view-journal');
        var eventsView = document.getElementById('view-events');
        var channelsView = document.getElementById('view-channels');
        dashView.classList.remove('active');
        trendView.classList.remove('active');
        if (bqmView) bqmView.classList.remove('active');
        if (speedtestView) speedtestView.classList.remove('active');
        if (journalView) journalView.classList.remove('active');
        if (eventsView) eventsView.classList.remove('active');
        if (channelsView) channelsView.classList.remove('active');
        stopAutoRefresh();
        if (view === 'live') {
            dashView.classList.add('active');
            updateDateLabel();
            if (!isHistorical) startAutoRefresh();
        } else if (view === 'bqm') {
            if (bqmView) bqmView.classList.add('active');
            updateDateLabel();
            loadBqmGraph(selectedDate);
        } else if (view === 'speedtest') {
            if (speedtestView) speedtestView.classList.add('active');
            updateDateLabel();
            loadSpeedtestHistory();
        } else if (view === 'journal') {
            if (journalView) journalView.classList.add('active');
            updateDateLabel();
            loadIncidents();
        } else if (view === 'events') {
            if (eventsView) eventsView.classList.add('active');
            updateDateLabel();
            loadEvents();
        } else if (view === 'channels') {
            if (channelsView) channelsView.classList.add('active');
            updateDateLabel();
            loadChannelList();
        } else if (view === 'trends') {
            trendView.classList.add('active');
            updateTrendTabs();
            updateDateLabel();
            loadTrends(_trendRange, selectedDate);
        }
    }

    /* ── Trend Tabs ── */
    function updateTrendTabs() {
        document.querySelectorAll('#trend-tabs .trend-tab').forEach(function(btn) {
            btn.classList.toggle('active', btn.getAttribute('data-range') === _trendRange);
        });
    }
    document.querySelectorAll('#trend-tabs .trend-tab').forEach(function(btn) {
        btn.addEventListener('click', function() {
            _trendRange = this.getAttribute('data-range');
            updateTrendTabs();
            updateDateLabel();
            loadTrends(_trendRange, selectedDate);
        });
    });

    /* ── Hash-based view routing ── */
    var validViews = ['live', 'trends', 'bqm', 'speedtest', 'journal', 'events', 'channels'];
    function viewFromHash() {
        var h = location.hash.replace('#', '');
        return validViews.indexOf(h) !== -1 ? h : null;
    }
    window.addEventListener('hashchange', function() {
        var v = viewFromHash();
        if (v && v !== currentView) switchView(v, true);
    });

    /* ── Date Navigation ── */
    var dateLabel = document.getElementById('date-label');
    var datePrev = document.getElementById('date-prev');
    var dateNext = document.getElementById('date-next');

    function updateDateLabel() {
        var trendTabs = document.getElementById('trend-tabs');
        if (currentView === 'live') {
            dateLabel.textContent = isHistorical ? formatDateDE('{{ snapshot_ts[:10] if snapshot_ts else "" }}') : T.live;
        } else if (currentView === 'bqm') {
            dateLabel.textContent = formatDateDE(selectedDate) + ' (BQM)';
        } else if (currentView === 'speedtest') {
            dateLabel.textContent = T.speedtest || 'Speedtest';
        } else if (currentView === 'journal') {
            dateLabel.textContent = T.incident_journal || 'Incident Journal';
        } else if (currentView === 'trends') {
            var rangeLabel = {day: T.day, week: T.week, month: T.month}[_trendRange] || '';
            if (selectedDate === todayStr()) {
                dateLabel.textContent = T.live + ' (' + rangeLabel + ')';
            } else {
                dateLabel.textContent = formatDateDE(selectedDate) + ' (' + rangeLabel + ')';
            }
            // Hide tabs when viewing historical data (not today)
            if (trendTabs) {
                trendTabs.style.display = (selectedDate === todayStr()) ? '' : 'none';
            }
        }
        // Show tabs again when switching to trends with today's date
        if (currentView !== 'trends' && trendTabs) {
            trendTabs.style.display = '';
        }
    }

    datePrev.addEventListener('click', function() { dateNav(-1); });
    dateNext.addEventListener('click', function() { dateNav(1); });

    function dateNav(dir) {
        var d = new Date(selectedDate + 'T12:00:00');
        var navRange = currentView === 'trends' ? _trendRange : currentView;
        if (navRange === 'live' || navRange === 'day' || navRange === 'bqm') {
            d.setDate(d.getDate() + dir);
        } else if (navRange === 'week') {
            d.setDate(d.getDate() + dir * 7);
        } else if (navRange === 'month') {
            d.setMonth(d.getMonth() + dir);
        }
        selectedDate = d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate());
        updateDateLabel();
        if (currentView === 'live') {
            fetch('/api/snapshot/daily?date=' + selectedDate)
                .then(function(r) { return r.json(); })
                .then(function(snap) {
                    if (snap && snap.timestamp) {
                        window.location.href = '/?t=' + encodeURIComponent(snap.timestamp);
                    }
                });
        } else if (currentView === 'bqm') {
            loadBqmGraph(selectedDate);
        } else if (currentView === 'trends') {
            // Force day view when navigating to historical dates
            if (selectedDate !== todayStr()) {
                _trendRange = 'day';
            }
            loadTrends(_trendRange, selectedDate);
        }
    }

    /* ── Calendar ── */
    var calPopup = document.getElementById('calendar-popup');

    dateLabel.addEventListener('click', function(e) {
        e.stopPropagation();
        calPopup.classList.toggle('open');
        if (calPopup.classList.contains('open') && !calendarLoaded) {
            loadCalendarData();
        } else if (calPopup.classList.contains('open')) {
            renderCalendar();
        }
    });
    document.addEventListener('click', function(e) {
        if (!calPopup.contains(e.target) && e.target !== dateLabel) {
            calPopup.classList.remove('open');
        }
    });
    document.getElementById('cal-prev').addEventListener('click', function() {
        calendarMonth.setMonth(calendarMonth.getMonth() - 1);
        renderCalendar();
    });
    document.getElementById('cal-next').addEventListener('click', function() {
        calendarMonth.setMonth(calendarMonth.getMonth() + 1);
        renderCalendar();
    });

    var bqmDates = [];

    function loadCalendarData() {
        fetch('/api/calendar')
            .then(function(r) { return r.json(); })
            .then(function(dates) {
                datesWithData = dates;
                calendarLoaded = true;
                renderCalendar();
            });
        fetch('/api/bqm/dates')
            .then(function(r) { return r.json(); })
            .then(function(dates) { bqmDates = dates || []; })
            .catch(function() {});
    }

    function renderCalendar() {
        var year = calendarMonth.getFullYear();
        var month = calendarMonth.getMonth();
        document.getElementById('cal-month-label').textContent = T.months[month] + ' ' + year;
        var grid = document.getElementById('cal-days');
        grid.innerHTML = '';
        var firstDay = new Date(year, month, 1).getDay();
        var offset = (firstDay === 0) ? 6 : firstDay - 1;
        var daysInMonth = new Date(year, month + 1, 0).getDate();
        var today = todayStr();
        for (var i = 0; i < offset; i++) {
            var empty = document.createElement('span');
            empty.className = 'cal-day empty';
            grid.appendChild(empty);
        }
        for (var d = 1; d <= daysInMonth; d++) {
            var dateStr = year + '-' + pad(month + 1) + '-' + pad(d);
            var el = document.createElement('span');
            el.className = 'cal-day';
            el.textContent = d;
            var activeDates = (currentView === 'bqm') ? bqmDates : datesWithData;
            if (activeDates.indexOf(dateStr) !== -1) el.classList.add('has-data');
            if (dateStr === today) el.classList.add('today');
            if (dateStr === selectedDate) el.classList.add('selected');
            el.setAttribute('data-date', dateStr);
            el.addEventListener('click', function() {
                var date = this.getAttribute('data-date');
                if (!this.classList.contains('has-data')) return;
                selectedDate = date;
                calPopup.classList.remove('open');
                if (currentView === 'live') {
                    fetch('/api/snapshot/daily?date=' + date)
                        .then(function(r) { return r.json(); })
                        .then(function(snap) {
                            if (snap && snap.timestamp) {
                                window.location.href = '/?t=' + encodeURIComponent(snap.timestamp);
                            }
                        });
                } else if (currentView === 'bqm') {
                    updateDateLabel();
                    loadBqmGraph(selectedDate);
                } else if (currentView === 'trends') {
                    updateDateLabel();
                    loadTrends(_trendRange, selectedDate);
                }
            });
            grid.appendChild(el);
        }
    }

    /* ── Auto Refresh ── */
    var refreshTimer = null;
    function startAutoRefresh() {
        stopAutoRefresh();
        refreshTimer = setInterval(function() {
            if (currentView === 'live' && !isHistorical && !document.hidden) {
                refreshData();
            }
        }, 60000);
    }
    function stopAutoRefresh() {
        if (refreshTimer) { clearInterval(refreshTimer); refreshTimer = null; }
    }

    function refreshData() {
        fetch(window.location.href)
            .then(function(r) { return r.text(); })
            .then(function(html) {
                var doc = new DOMParser().parseFromString(html, 'text/html');

                // Save expanded metric cards by index
                var openCardIndices = [];
                document.querySelectorAll('.metric-card').forEach(function(el, i) {
                    if (el.classList.contains('open')) openCardIndices.push(i);
                });

                // Save expanded channel groups by label text
                var openGroupLabels = [];
                document.querySelectorAll('details.channel-group[open]').forEach(function(el) {
                    var s = el.querySelector('summary');
                    if (s) openGroupLabels.push(s.textContent.trim());
                });

                // Replace dashboard content
                var freshDash = doc.querySelector('#view-dashboard');
                var currentDash = document.querySelector('#view-dashboard');
                if (freshDash && currentDash) {
                    currentDash.innerHTML = freshDash.innerHTML;
                }

                // Update topbar timestamp
                var freshMeta = doc.querySelector('#topbar-meta');
                var currentMeta = document.querySelector('#topbar-meta');
                if (freshMeta && currentMeta) {
                    currentMeta.innerHTML = freshMeta.innerHTML;
                }

                // Restore expanded metric cards
                document.querySelectorAll('.metric-card').forEach(function(el, i) {
                    if (openCardIndices.indexOf(i) !== -1) el.classList.add('open');
                });

                // Restore expanded channel groups
                document.querySelectorAll('details.channel-group').forEach(function(el) {
                    var s = el.querySelector('summary');
                    if (s && openGroupLabels.indexOf(s.textContent.trim()) !== -1) {
                        el.setAttribute('open', '');
                    }
                });

                // Re-init sortable tables (event listeners lost on innerHTML replace)
                initSortableTables();

                // Refresh event badge count
                fetch('/api/events/count')
                    .then(function(r) { return r.json(); })
                    .then(function(d) { updateEventBadge(d.count || 0); })
                    .catch(function() {});
            })
            .catch(function(err) {
                console.warn('Auto-refresh failed:', err);
            });
    }

    if (!isHistorical && currentView === 'live') startAutoRefresh();

    /* ── Manual Poll (Refresh Button) ── */
    var refreshBtn = document.getElementById('refresh-btn');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
            if (refreshBtn.disabled) return;
            refreshBtn.disabled = true;
            refreshBtn.classList.add('spinning');
            fetch('/api/poll', {method: 'POST'})
                .then(function(r) { return r.json().then(function(d) { return {status: r.status, data: d}; }); })
                .then(function(res) {
                    if (res.data.success) {
                        showToast(T.refresh_success || 'Data updated', 'success');
                        refreshData();
                    } else {
                        showToast(res.data.error || 'Error', res.status === 429 ? 'error' : 'error');
                    }
                })
                .catch(function() { showToast(T.network_error || 'Error', 'error'); })
                .finally(function() {
                    refreshBtn.classList.remove('spinning');
                    setTimeout(function() { refreshBtn.disabled = false; }, 10000);
                });
        });
    }

    function showToast(msg, type) {
        var toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.className = 'toast toast-' + (type || 'success') + ' show';
        setTimeout(function() { toast.classList.remove('show'); }, 3000);
    }

    /* ── Trend Charts ── */
    var DS_POWER_ZONES = [
        {min: -15, max: -8, color: "rgba(244,67,54,0.35)"},
        {min: -8, max: -4, color: "rgba(255,152,0,0.30)"},
        {min: -4, max: 13, color: "rgba(76,175,80,0.25)"},
        {min: 13, max: 20, color: "rgba(255,152,0,0.30)"},
        {min: 20, max: 25, color: "rgba(244,67,54,0.35)"},
        {yMin: -12, yMax: 22}
    ];
    var DS_SNR_ZONES = [
        {min: 15, max: 29, color: "rgba(244,67,54,0.35)"},
        {min: 29, max: 33, color: "rgba(255,152,0,0.30)"},
        {min: 33, max: 50, color: "rgba(76,175,80,0.25)"},
        {yMin: 25, yMax: 45}
    ];
    var US_POWER_ZONES = [
        {min: 20, max: 35, color: "rgba(244,67,54,0.35)"},
        {min: 35, max: 41, color: "rgba(255,152,0,0.30)"},
        {min: 41, max: 47, color: "rgba(76,175,80,0.25)"},
        {min: 47, max: 53, color: "rgba(255,152,0,0.30)"},
        {min: 53, max: 65, color: "rgba(244,67,54,0.35)"},
        {yMin: 30, yMax: 60}
    ];

    function loadTrends(range, date) {
        var title = document.getElementById('trend-title');
        var noData = document.getElementById('trend-no-data');
        var grid = document.getElementById('charts-grid');
        var labels = {day: T.day_trend, week: T.week_trend, month: T.month_trend};
        title.textContent = (labels[range] || 'Trend') + ' - ' + formatDateDE(date);

        fetch('/api/trends?range=' + range + '&date=' + date)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (!data || data.length === 0) {
                    noData.textContent = T.no_data;
                    noData.style.display = 'block';
                    grid.style.display = 'none';
                    return;
                }
                noData.style.display = 'none';
                grid.style.display = '';
                var xLabels = data.map(function(d) {
                    if (range === 'day') return d.timestamp ? d.timestamp.substring(11, 16) : '';
                    return d.date ? formatDateDE(d.date) : '';
                });
                renderChart('chart-ds-power', xLabels,
                    [{label: 'DS Power Avg', data: data.map(function(d){ return d.ds_power_avg; }), color: '#00e5f0'}],
                    null, DS_POWER_ZONES);
                renderChart('chart-ds-snr', xLabels,
                    [{label: 'DS SNR Avg', data: data.map(function(d){ return d.ds_snr_avg; }), color: '#66ff77'}],
                    null, DS_SNR_ZONES);
                renderChart('chart-us-power', xLabels,
                    [{label: 'US Power Avg', data: data.map(function(d){ return d.us_power_avg; }), color: '#ffbb33'}],
                    null, US_POWER_ZONES);
                renderChart('chart-errors', xLabels, [
                    {label: T.correctable, data: data.map(function(d){ return d.ds_correctable_errors; }), color: '#2196f3'},
                    {label: T.uncorrectable, data: data.map(function(d){ return d.ds_uncorrectable_errors; }), color: '#f44336'}
                ], 'bar');
            })
            .catch(function() {
                noData.textContent = T.trend_error;
                noData.style.display = 'block';
                grid.style.display = 'none';
            });
    }

    var zonesPlugin = {
        id: 'zones',
        beforeDatasetsDraw: function(chart) {
            var zones = chart._docsightZones;
            if (!zones) return;
            var ctx = chart.ctx;
            var yAxis = chart.scales.y;
            var xAxis = chart.scales.x;
            var isDark = document.documentElement.getAttribute('data-theme') !== 'light';
            var lineColor = isDark ? 'rgba(255,255,255,0.3)' : 'rgba(0,0,0,0.2)';
            // Clip to chart area only (don't bleed into axis labels)
            var chartArea = chart.chartArea;
            ctx.save();
            ctx.beginPath();
            ctx.rect(chartArea.left, chartArea.top, chartArea.right - chartArea.left, chartArea.bottom - chartArea.top);
            ctx.clip();
            var drawn = {};
            zones.forEach(function(z) {
                var top = yAxis.getPixelForValue(z.max);
                var bottom = yAxis.getPixelForValue(z.min);
                ctx.fillStyle = z.color;
                ctx.fillRect(chartArea.left, top, chartArea.right - chartArea.left, bottom - top);
                // Draw dashed boundary lines at zone edges in zone color
                var zoneBaseColor = z.color.replace(/[\d.]+\)$/, '0.7)');
                [z.min, z.max].forEach(function(val) {
                    if (drawn[val]) return;
                    drawn[val] = true;
                    var py = yAxis.getPixelForValue(val);
                    ctx.beginPath();
                    ctx.setLineDash([6, 4]);
                    ctx.strokeStyle = zoneBaseColor;
                    ctx.lineWidth = 1.5;
                    ctx.moveTo(chartArea.left, py);
                    ctx.lineTo(chartArea.right, py);
                    ctx.stroke();
                });
            });
            ctx.restore();
        }
    };

    function renderChart(canvasId, labels, datasets, type, zones) {
        if (charts[canvasId]) charts[canvasId].destroy();
        var ctx = document.getElementById(canvasId);
        if (!ctx) return;
        var isDark = document.documentElement.getAttribute('data-theme') !== 'light';
        var gridColor = isDark ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.08)';
        var textColor = isDark ? '#888' : '#666';
        var chartDatasets = datasets.map(function(ds) {
            return {
                label: ds.label, data: ds.data,
                borderColor: ds.color,
                backgroundColor: ds.color + (type === 'bar' ? 'cc' : '22'),
                borderWidth: 3, tension: 0.3,
                pointRadius: labels.length > 30 ? 0 : 3,
                fill: type !== 'bar'
            };
        });
        var hasLegend = datasets.length > 1;
        var legendPos = hasLegend ? 'bottom' : 'top';
        var chartConfig = {
            type: type || 'line',
            data: { labels: labels, datasets: chartDatasets },
            options: {
                responsive: true, maintainAspectRatio: true,
                interaction: { intersect: false, mode: 'index' },
                plugins: {
                    legend: { display: hasLegend, position: legendPos, labels: { color: textColor, font: { size: 11 } } },
                    tooltip: { backgroundColor: isDark ? '#16213e' : '#fff', titleColor: textColor, bodyColor: textColor, borderColor: gridColor, borderWidth: 1 }
                },
                scales: {
                    x: { ticks: { color: textColor, font: { size: 10 }, maxRotation: 45 }, grid: { color: gridColor } },
                    y: { ticks: { color: textColor, font: { size: 10 } }, grid: { color: gridColor } }
                }
            },
            plugins: zones ? [zonesPlugin] : []
        };
        if (zones) {
            // Filter out the yMin/yMax metadata entry and use it for axis limits
            var zoneMeta = zones.find(function(z) { return z.yMin !== undefined; });
            if (zoneMeta) {
                chartConfig.options.scales.y.suggestedMin = zoneMeta.yMin;
                chartConfig.options.scales.y.suggestedMax = zoneMeta.yMax;
            }
        }
        charts[canvasId] = new Chart(ctx, chartConfig);
        if (zones) {
            charts[canvasId]._docsightZones = zones.filter(function(z) { return z.color; });
        }
        /* Store render params so the zoom modal can re-render this chart */
        charts[canvasId]._docsightParams = {labels: labels, datasets: datasets, type: type, zones: zones};
    }

    /* ── Chart Zoom Modal ── */
    var zoomChart = null;

    window.closeChartZoom = closeChartZoom;

    function openChartZoom(canvasId) {
        var src = charts[canvasId];
        if (!src || !src._docsightParams) return;
        var params = src._docsightParams;
        var card = document.getElementById(canvasId).closest('.chart-card');
        var label = card ? card.querySelector('.chart-label') : null;
        document.getElementById('chart-zoom-title').textContent = label ? label.textContent : '';
        var overlay = document.getElementById('chart-zoom-overlay');
        overlay.classList.add('open');
        /* Re-render the chart on the modal canvas (maintainAspectRatio: false to fill) */
        setTimeout(function() {
            if (zoomChart) { zoomChart.destroy(); zoomChart = null; }
            var ctx = document.getElementById('chart-zoom-canvas');
            var isDark = document.documentElement.getAttribute('data-theme') !== 'light';
            var gridColor = isDark ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.08)';
            var textColor = isDark ? '#888' : '#666';
            var chartDatasets = params.datasets.map(function(ds) {
                return {
                    label: ds.label, data: ds.data,
                    borderColor: ds.color,
                    backgroundColor: ds.color + (params.type === 'bar' ? 'cc' : '22'),
                    borderWidth: 3, tension: 0.3,
                    pointRadius: params.labels.length > 30 ? 2 : 4,
                    fill: params.type !== 'bar'
                };
            });
            var hasLegend = params.datasets.length > 1;
            var cfg = {
                type: params.type || 'line',
                data: { labels: params.labels, datasets: chartDatasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    plugins: {
                        legend: { display: hasLegend, position: 'bottom', labels: { color: textColor, font: { size: 12 } } },
                        tooltip: { backgroundColor: isDark ? '#16213e' : '#fff', titleColor: textColor, bodyColor: textColor, borderColor: gridColor, borderWidth: 1 }
                    },
                    scales: {
                        x: { ticks: { color: textColor, font: { size: 11 }, maxRotation: 45 }, grid: { color: gridColor } },
                        y: { ticks: { color: textColor, font: { size: 11 } }, grid: { color: gridColor } }
                    }
                },
                plugins: params.zones ? [zonesPlugin] : []
            };
            if (params.zones) {
                var zoneMeta = params.zones.find(function(z) { return z.yMin !== undefined; });
                if (zoneMeta) {
                    cfg.options.scales.y.suggestedMin = zoneMeta.yMin;
                    cfg.options.scales.y.suggestedMax = zoneMeta.yMax;
                }
            }
            zoomChart = new Chart(ctx, cfg);
            if (params.zones) {
                zoomChart._docsightZones = params.zones.filter(function(z) { return z.color; });
            }
        }, 50);
    }

    function closeChartZoom() {
        document.getElementById('chart-zoom-overlay').classList.remove('open');
        if (zoomChart) { zoomChart.destroy(); zoomChart = null; }
    }

    /* Expand button click handlers */
    document.querySelectorAll('.chart-expand-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            openChartZoom(btn.getAttribute('data-chart'));
        });
    });

    /* Close chart zoom on Escape */
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.getElementById('chart-zoom-overlay').classList.contains('open')) {
            closeChartZoom();
        }
        if (e.key === 'Escape' && document.getElementById('changelog-modal') && document.getElementById('changelog-modal').classList.contains('open')) {
            closeChangelogModal();
        }
    });

    /* ── Changelog Modal ── */
    {% if changelog %}
    var _changelogVersion = {{ changelog.version|tojson }};
    (function() {
        var seen = localStorage.getItem('docsight-last-seen-version');
        if (seen !== _changelogVersion) {
            var modal = document.getElementById('changelog-modal');
            if (modal) { modal.classList.add('open'); }
        }
    })();
    {% endif %}

    function closeChangelogModal() {
        var modal = document.getElementById('changelog-modal');
        if (modal) { modal.classList.remove('open'); }
        {% if changelog %}
        localStorage.setItem('docsight-last-seen-version', _changelogVersion);
        {% endif %}
    }
    window.closeChangelogModal = closeChangelogModal;

    /* ── BQM Graph ── */
    function loadBqmGraph(date) {
        var img = document.getElementById('bqm-image');
        var noData = document.getElementById('bqm-no-data');
        if (!img || !noData) return;
        img.style.display = 'none';
        noData.style.display = 'none';
        img.onload = function() { img.style.display = 'inline-block'; };
        img.onerror = function() {
            img.style.display = 'none';
            noData.textContent = T.bqm_no_data || 'No BQM graph for this date.';
            noData.style.display = 'block';
        };
        img.src = '/api/bqm/image/' + date;
    }

    /* ── Init ── */
    updateDateLabel();

    // Apply hash-based view routing (must be inside IIFE to access switchView)
    var _initHash = location.hash.replace('#', '');
    if (validViews.indexOf(_initHash) !== -1 && _initHash !== 'live') {
        switchView(_initHash, true);
    }

    /* ── Incident Journal ── */
    var _incidentsLoaded = false;
    var _journalSortCol = 'date';
    var _journalSortAsc = false;

    function loadIncidents() {
        var table = document.getElementById('journal-table');
        var tbody = document.getElementById('journal-tbody');
        var empty = document.getElementById('journal-empty');
        var loading = document.getElementById('journal-loading');
        loading.style.display = '';
        tbody.innerHTML = '';
        table.style.display = 'none';
        empty.style.display = 'none';
        fetch('/api/incidents')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                loading.style.display = 'none';
                if (!data || data.length === 0) {
                    empty.textContent = T.no_incidents || 'No incidents logged yet.';
                    empty.style.display = '';
                    return;
                }
                _incidentsLoaded = true;
                renderJournalTable(data);
            })
            .catch(function() {
                loading.style.display = 'none';
                empty.textContent = T.network_error || 'Error';
                empty.style.display = '';
            });
    }

    function renderJournalTable(data) {
        var table = document.getElementById('journal-table');
        var tbody = document.getElementById('journal-tbody');
        data.sort(function(a, b) {
            var va, vb;
            if (_journalSortCol === 'date') { va = a.date || ''; vb = b.date || ''; }
            else if (_journalSortCol === 'title') { va = (a.title || '').toLowerCase(); vb = (b.title || '').toLowerCase(); }
            else { va = (a.description || '').toLowerCase(); vb = (b.description || '').toLowerCase(); }
            if (va < vb) return _journalSortAsc ? -1 : 1;
            if (va > vb) return _journalSortAsc ? 1 : -1;
            return 0;
        });
        tbody.innerHTML = '';
        data.forEach(function(inc) {
            var tr = document.createElement('tr');
            tr.setAttribute('data-id', inc.id);
            tr.onclick = function() { openIncidentModal(inc.id); };
            var desc = inc.description || '';
            if (desc.length > 80) desc = desc.substring(0, 80) + '…';
            var clipCell = inc.attachment_count > 0 ? '&#128206; ' + inc.attachment_count : '';
            tr.innerHTML =
                '<td>' + formatDateDE(inc.date) + '</td>' +
                '<td>' + escapeHtml(inc.title) + '</td>' +
                '<td class="journal-desc journal-hide-mobile">' + escapeHtml(desc) + '</td>' +
                '<td class="journal-clip">' + clipCell + '</td>';
            tbody.appendChild(tr);
        });
        // Update sort indicators in header
        var ths = table.querySelectorAll('thead th[data-col]');
        for (var i = 0; i < ths.length; i++) {
            ths[i].className = ths[i].getAttribute('data-col') === _journalSortCol ? (_journalSortAsc ? 'sort-asc' : 'sort-desc') : '';
            // Preserve journal-hide-mobile on description column
            if (ths[i].getAttribute('data-col') === 'description') {
                ths[i].className = (ths[i].className ? ths[i].className + ' ' : '') + 'journal-hide-mobile';
            }
        }
        table.style.display = '';
    }

    (function() {
        var table = document.getElementById('journal-table');
        if (table) {
            table.addEventListener('click', function(e) {
                var th = e.target.closest ? e.target.closest('th[data-col]') : null;
                if (!th) return;
                var col = th.getAttribute('data-col');
                if (col === _journalSortCol) {
                    _journalSortAsc = !_journalSortAsc;
                } else {
                    _journalSortCol = col;
                    _journalSortAsc = col === 'date' ? false : true;
                }
                loadIncidents();
            });
        }
    })();

    /* ── Event Log ── */
    var _eventsOffset = 0;
    var _eventsPageSize = 50;
    var _eventTypeLabels = {
        health_change: T.event_type_health_change || 'Health Change',
        power_change: T.event_type_power_change || 'Power Change',
        snr_change: T.event_type_snr_change || 'SNR Change',
        channel_change: T.event_type_channel_change || 'Channel Change',
        modulation_change: T.event_type_modulation_change || 'Modulation Change',
        error_spike: T.event_type_error_spike || 'Error Spike'
    };
    var _sevLabels = {
        info: T.event_severity_info || 'Info',
        warning: T.event_severity_warning || 'Warning',
        critical: T.event_severity_critical || 'Critical'
    };

    function loadEvents(append) {
        if (!append) _eventsOffset = 0;
        var severity = document.getElementById('events-filter-severity').value;
        var evType = document.getElementById('events-filter-type').value;
        var params = '?limit=' + _eventsPageSize + '&offset=' + _eventsOffset;
        if (severity) params += '&severity=' + severity;
        if (evType) params += '&event_type=' + evType;

        var tbody = document.getElementById('events-tbody');
        var table = document.getElementById('events-table');
        var empty = document.getElementById('events-empty');
        var loading = document.getElementById('events-loading');
        var moreBtn = document.getElementById('events-show-more');
        var ackAllBtn = document.getElementById('btn-ack-all');

        if (!append) {
            loading.style.display = '';
            tbody.innerHTML = '';
            table.style.display = 'none';
            empty.style.display = 'none';
            moreBtn.style.display = 'none';
        }

        fetch('/api/events' + params)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                loading.style.display = 'none';
                var events = data.events || [];
                var unack = data.unacknowledged_count || 0;
                updateEventBadge(unack);
                ackAllBtn.style.display = unack > 0 ? '' : 'none';

                if (events.length === 0 && !append) {
                    empty.textContent = T.event_no_events || 'No events detected yet.';
                    empty.style.display = '';
                    return;
                }
                events.forEach(function(ev) {
                    var tr = document.createElement('tr');
                    if (ev.acknowledged) tr.className = 'event-acked';
                    tr.setAttribute('data-event-id', ev.id);
                    var sevClass = 'sev-badge-' + ev.severity;
                    var sevLabel = _sevLabels[ev.severity] || ev.severity;
                    var typeLabel = _eventTypeLabels[ev.event_type] || ev.event_type;
                    var ackBtn = ev.acknowledged
                        ? '<span style="color:var(--muted);font-size:0.8em;">&#10003;</span>'
                        : '<button class="btn-ack" onclick="acknowledgeEvent(' + ev.id + ', event)">&#10003;</button>';
                    tr.innerHTML =
                        '<td style="white-space:nowrap;">' + escapeHtml(ev.timestamp.replace('T', ' ')) + '</td>' +
                        '<td><span class="' + sevClass + '">' + sevLabel + '</span></td>' +
                        '<td>' + escapeHtml(typeLabel) + '</td>' +
                        '<td class="event-msg">' + escapeHtml(ev.message) + '</td>' +
                        '<td class="event-actions">' + ackBtn + '</td>';
                    if (ev.details) {
                        tr.style.cursor = 'pointer';
                        tr.onclick = function(e) {
                            if (e.target.tagName === 'BUTTON') return;
                            toggleEventDetail(ev.id, ev.details);
                        };
                    }
                    tbody.appendChild(tr);
                });
                table.style.display = '';
                moreBtn.style.display = events.length >= _eventsPageSize ? '' : 'none';
            })
            .catch(function() {
                loading.style.display = 'none';
                empty.textContent = T.network_error || 'Error';
                empty.style.display = '';
            });
    }

    function loadMoreEvents() {
        _eventsOffset += _eventsPageSize;
        loadEvents(true);
    }

    function toggleEventDetail(eventId, details) {
        var existing = document.getElementById('event-detail-' + eventId);
        if (existing) {
            existing.remove();
            return;
        }
        var eventRow = document.querySelector('tr[data-event-id="' + eventId + '"]');
        if (!eventRow) return;
        var detailRow = document.createElement('tr');
        detailRow.id = 'event-detail-' + eventId;
        detailRow.className = 'event-detail-row';
        var td = document.createElement('td');
        td.colSpan = 5;
        var pre = document.createElement('pre');
        pre.textContent = JSON.stringify(details, null, 2);
        td.appendChild(pre);
        detailRow.appendChild(td);
        eventRow.parentNode.insertBefore(detailRow, eventRow.nextSibling);
    }

    function acknowledgeEvent(eventId, e) {
        if (e) e.stopPropagation();
        fetch('/api/events/' + eventId + '/acknowledge', { method: 'POST' })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.success) loadEvents();
            });
    }

    function acknowledgeAllEvents() {
        fetch('/api/events/acknowledge-all', { method: 'POST' })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.success) loadEvents();
            });
    }

    function updateEventBadge(count) {
        var badge = document.getElementById('event-badge');
        if (!badge) return;
        if (count > 0) {
            badge.textContent = count > 99 ? '99+' : count;
            badge.style.display = '';
        } else {
            badge.style.display = 'none';
        }
    }

    window.acknowledgeEvent = acknowledgeEvent;
    window.acknowledgeAllEvents = acknowledgeAllEvents;
    window.loadEvents = loadEvents;

    // Fetch badge count on page load
    fetch('/api/events/count')
        .then(function(r) { return r.json(); })
        .then(function(data) { updateEventBadge(data.count || 0); })
        .catch(function() {});

    /* ── Channel Timeline ── */
    var _channelsLoaded = false;

    function loadChannelList() {
        if (_channelsLoaded) return;
        var sel = document.getElementById('channel-select');
        fetch('/api/channels')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                sel.innerHTML = '<option value="">' + (T.select_channel || 'Select Channel') + '</option>';
                var ds = data.ds_channels || [];
                var us = data.us_channels || [];
                if (ds.length) {
                    var grp = document.createElement('optgroup');
                    grp.label = T.downstream_channels || 'Downstream Channels';
                    ds.forEach(function(ch) {
                        var opt = document.createElement('option');
                        opt.value = 'ds-' + ch.channel_id;
                        opt.textContent = 'DS ' + ch.channel_id + ' (' + (ch.frequency || '') + ')';
                        grp.appendChild(opt);
                    });
                    sel.appendChild(grp);
                }
                if (us.length) {
                    var grp2 = document.createElement('optgroup');
                    grp2.label = T.upstream_channels || 'Upstream Channels';
                    us.forEach(function(ch) {
                        var opt = document.createElement('option');
                        opt.value = 'us-' + ch.channel_id;
                        opt.textContent = 'US ' + ch.channel_id + ' (' + (ch.frequency || '') + ')';
                        grp2.appendChild(opt);
                    });
                    sel.appendChild(grp2);
                }
                _channelsLoaded = true;
            })
            .catch(function() {});
    }

    function loadChannelTimeline() {
        var sel = document.getElementById('channel-select');
        var val = sel.value;
        var chartsEl = document.getElementById('channel-charts');
        var emptyEl = document.getElementById('channel-empty');
        var loadingEl = document.getElementById('channel-loading');
        if (!val) {
            chartsEl.style.display = 'none';
            emptyEl.style.display = 'none';
            return;
        }
        var parts = val.split('-');
        var direction = parts[0];
        var channelId = parts[1];
        var days = document.getElementById('channel-time-range').value;

        loadingEl.style.display = '';
        chartsEl.style.display = 'none';
        emptyEl.style.display = 'none';

        fetch('/api/channel-history?channel_id=' + channelId + '&direction=' + direction + '&days=' + days)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                loadingEl.style.display = 'none';
                if (!data || data.length === 0) {
                    emptyEl.textContent = T.no_channel_data || 'No data available for this channel.';
                    emptyEl.style.display = '';
                    return;
                }
                chartsEl.style.display = '';
                var xLabels = data.map(function(d) {
                    if (!d.timestamp) return '';
                    if (parseInt(days) <= 1) return d.timestamp.substring(11, 16);
                    return d.timestamp.substring(5, 16).replace('T', ' ');
                });
                var powerDatasets = [{label: T.power_dbmv || 'Power (dBmV)', data: data.map(function(d){ return d.power; }), color: '#00e5f0'}];
                var powerZones = direction === 'ds' ? DS_POWER_ZONES : US_POWER_ZONES;
                var powerLabel = document.querySelector('#channel-charts .chart-card:first-child .chart-label');
                if (direction === 'ds') {
                    powerDatasets.push({label: T.snr_db || 'SNR (dB)', data: data.map(function(d){ return d.snr; }), color: '#66ff77'});
                    powerZones = null;
                    if (powerLabel) powerLabel.textContent = (T.power_dbmv || 'Power') + ' & ' + (T.snr_db || 'SNR');
                } else {
                    if (powerLabel) powerLabel.textContent = T.power_dbmv || 'Power (dBmV)';
                }
                renderChart('chart-ch-power', xLabels, powerDatasets, null, powerZones);
                renderChart('chart-ch-errors', xLabels, [
                    {label: T.correctable || 'Correctable', data: data.map(function(d){ return d.correctable_errors; }), color: '#2196f3'},
                    {label: T.uncorrectable || 'Uncorrectable', data: data.map(function(d){ return d.uncorrectable_errors; }), color: '#f44336'}
                ], 'bar');

                // Modulation badges
                var modEl = document.getElementById('channel-modulation-badges');
                var modCard = document.getElementById('channel-modulation-card');
                var mods = data.filter(function(d) { return d.modulation; });
                if (mods.length === 0) {
                    modCard.style.display = 'none';
                } else {
                    modCard.style.display = '';
                    var changes = [{ts: mods[0].timestamp, mod: mods[0].modulation}];
                    for (var i = 1; i < mods.length; i++) {
                        if (mods[i].modulation !== mods[i - 1].modulation) {
                            changes.push({ts: mods[i].timestamp, mod: mods[i].modulation});
                        }
                    }
                    var html = '';
                    if (changes.length === 1) {
                        html = '<span class="mod-badge">' + (T.modulation || 'Modulation') + ': ' + escapeHtml(changes[0].mod) + '</span>';
                    } else {
                        for (var j = 0; j < changes.length; j++) {
                            var tsLabel = changes[j].ts.substring(5, 16).replace('T', ' ');
                            var cls = j === 0 ? 'mod-badge' : 'mod-badge mod-badge-changed';
                            html += '<span class="' + cls + '"><span class="mod-ts">' + escapeHtml(tsLabel) + '</span>' + escapeHtml(changes[j].mod) + '</span>';
                        }
                    }
                    modEl.innerHTML = html;
                }
            })
            .catch(function() {
                loadingEl.style.display = 'none';
                emptyEl.textContent = T.trend_error || 'Error loading data.';
                emptyEl.style.display = '';
            });
    }
    window.loadChannelTimeline = loadChannelTimeline;

    function openIncidentModal(incidentId) {
        var modal = document.getElementById('incident-modal');
        var titleEl = document.getElementById('incident-modal-title');
        var idEl = document.getElementById('incident-id');
        var dateEl = document.getElementById('incident-date');
        var titleInput = document.getElementById('incident-title-input');
        var descEl = document.getElementById('incident-desc');
        var deleteBtn = document.getElementById('incident-delete-btn');
        var attachSection = document.getElementById('incident-attachments-section');
        var attachList = document.getElementById('incident-attachment-list');

        attachList.innerHTML = '';

        if (incidentId) {
            titleEl.textContent = T.edit_entry || 'Edit Entry';
            deleteBtn.style.display = '';
            fetch('/api/incidents/' + incidentId)
                .then(function(r) { return r.json(); })
                .then(function(inc) {
                    idEl.value = inc.id;
                    dateEl.value = inc.date;
                    titleInput.value = inc.title;
                    descEl.value = inc.description || '';
                    renderAttachments(inc.attachments || [], attachList, incidentId);
                    attachSection.style.display = '';
                    modal.classList.add('open');
                });
        } else {
            titleEl.textContent = T.new_entry || 'New Entry';
            idEl.value = '';
            dateEl.value = todayStr();
            titleInput.value = '';
            descEl.value = '';
            deleteBtn.style.display = 'none';
            attachSection.style.display = 'none';
            modal.classList.add('open');
        }
    }

    function closeIncidentModal() {
        document.getElementById('incident-modal').classList.remove('open');
    }

    function renderAttachments(attachments, container, incidentId) {
        container.innerHTML = '';
        attachments.forEach(function(att) {
            var item = document.createElement('div');
            item.className = 'attachment-item';
            var isImage = att.mime_type && att.mime_type.indexOf('image/') === 0;
            var thumbHtml = '';
            if (isImage) {
                thumbHtml = '<img class="attachment-thumb" src="/api/attachments/' + att.id + '" alt="">';
            } else if (att.mime_type === 'application/pdf') {
                thumbHtml = '<div class="attachment-icon">&#128196;</div>';
            } else {
                thumbHtml = '<div class="attachment-icon">&#128462;</div>';
            }
            item.innerHTML = thumbHtml +
                '<div class="attachment-info">' +
                    '<span class="attachment-name">' + escapeHtml(att.filename) + '</span>' +
                    '<div class="attachment-actions">' +
                        '<a href="/api/attachments/' + att.id + '" download title="Download">&#11015;</a>' +
                        '<button onclick="deleteAttachment(' + att.id + ', ' + incidentId + ')" title="Delete">&#128465;</button>' +
                    '</div>' +
                '</div>';
            container.appendChild(item);
        });
    }

    function saveIncident() {
        var idEl = document.getElementById('incident-id');
        var dateVal = document.getElementById('incident-date').value;
        var titleVal = document.getElementById('incident-title-input').value.trim();
        var descVal = document.getElementById('incident-desc').value.trim();
        var incidentId = idEl.value;

        if (!titleVal) {
            showToast(T.incident_title + ' required', 'error');
            return;
        }

        var payload = JSON.stringify({date: dateVal, title: titleVal, description: descVal});
        var url = incidentId ? '/api/incidents/' + incidentId : '/api/incidents';
        var method = incidentId ? 'PUT' : 'POST';

        fetch(url, {method: method, headers: {'Content-Type': 'application/json'}, body: payload})
            .then(function(r) { return r.json().then(function(d) { return {status: r.status, data: d}; }); })
            .then(function(res) {
                if (res.status >= 400) {
                    showToast(res.data.error || 'Error', 'error');
                    return;
                }
                loadIncidents();
                if (!incidentId && res.data.id) {
                    // New entry: switch modal to edit mode in-place (keep it open)
                    idEl.value = res.data.id;
                    document.getElementById('incident-modal-title').textContent = T.edit_entry || 'Edit Entry';
                    document.getElementById('incident-delete-btn').style.display = '';
                    document.getElementById('incident-attachments-section').style.display = '';
                    showToast(T.saved || 'Saved', 'ok');
                } else {
                    closeIncidentModal();
                }
            })
            .catch(function() { showToast(T.network_error || 'Error', 'error'); });
    }

    function deleteIncident() {
        var incidentId = document.getElementById('incident-id').value;
        if (!incidentId) return;
        if (!confirm(T.confirm_delete || 'Are you sure?')) return;
        fetch('/api/incidents/' + incidentId, {method: 'DELETE'})
            .then(function(r) { return r.json(); })
            .then(function() {
                closeIncidentModal();
                loadIncidents();
            })
            .catch(function() { showToast(T.network_error || 'Error', 'error'); });
    }

    function handleIncidentFileUpload(input) {
        var incidentId = document.getElementById('incident-id').value;
        if (!incidentId || !input.files || input.files.length === 0) return;
        var spinner = document.getElementById('incident-upload-spinner');
        var uploadBtn = document.getElementById('incident-upload-btn');
        spinner.style.display = 'inline';
        uploadBtn.disabled = true;
        var uploads = [];
        for (var i = 0; i < input.files.length; i++) {
            uploads.push(uploadOneFile(incidentId, input.files[i]));
        }
        Promise.all(uploads)
            .then(function(results) {
                var errors = results.filter(function(r) { return r.error; });
                if (errors.length > 0) {
                    showToast(errors[0].error, 'error');
                }
                spinner.style.display = 'none';
                uploadBtn.disabled = false;
                input.value = '';
                // Reload attachments
                fetch('/api/incidents/' + incidentId)
                    .then(function(r) { return r.json(); })
                    .then(function(inc) {
                        renderAttachments(inc.attachments || [], document.getElementById('incident-attachment-list'), incidentId);
                    });
            })
            .catch(function() {
                spinner.style.display = 'none';
                uploadBtn.disabled = false;
                showToast(T.network_error || 'Error', 'error');
            });
    }

    function uploadOneFile(incidentId, file) {
        var formData = new FormData();
        formData.append('file', file);
        return fetch('/api/incidents/' + incidentId + '/attachments', {method: 'POST', body: formData})
            .then(function(r) { return r.json().then(function(d) { return r.status >= 400 ? {error: d.error} : d; }); })
            .catch(function() { return {error: T.network_error || 'Upload failed'}; });
    }

    function deleteAttachment(attachmentId, incidentId) {
        fetch('/api/attachments/' + attachmentId, {method: 'DELETE'})
            .then(function(r) { return r.json(); })
            .then(function() {
                fetch('/api/incidents/' + incidentId)
                    .then(function(r) { return r.json(); })
                    .then(function(inc) {
                        renderAttachments(inc.attachments || [], document.getElementById('incident-attachment-list'), incidentId);
                    });
            })
            .catch(function() { showToast(T.network_error || 'Error', 'error'); });
    }

    /* Expose Journal functions for HTML onclick/onchange handlers */
    window.openIncidentModal = openIncidentModal;
    window.closeIncidentModal = closeIncidentModal;
    window.saveIncident = saveIncident;
    window.deleteIncident = deleteIncident;
    window.deleteAttachment = deleteAttachment;
    window.handleIncidentFileUpload = handleIncidentFileUpload;
    window.loadIncidents = loadIncidents;

})();

/* ── Export for LLM ── */
function exportForLLM() {
    var T = {{ t|tojson }};
    var modal = document.getElementById('export-modal');
    var textarea = document.getElementById('export-text');
    textarea.value = T.export_no_data;
    modal.classList.add('open');
    fetch('/api/export')
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.text) {
                textarea.value = data.text;
            } else if (data.error) {
                textarea.value = data.error;
            }
        })
        .catch(function() {
            textarea.value = 'Error loading export data.';
        });
}
function closeExportModal() {
    document.getElementById('export-modal').classList.remove('open');
}
function openBqmSetupModal() {
    document.getElementById('bqm-setup-modal').classList.add('open');
}
function closeBqmSetupModal() {
    document.getElementById('bqm-setup-modal').classList.remove('open');
}
function openReportModal() {
    document.getElementById('report-modal').classList.add('open');
    closeSidebar();
}
function closeReportModal() {
    document.getElementById('report-modal').classList.remove('open');
    // Reset to step 1
    document.getElementById('report-step1').style.display = '';
    document.getElementById('report-step2').style.display = 'none';
    document.getElementById('report-generate-btn').style.display = '';
    document.getElementById('report-copy-btn').style.display = 'none';
    document.getElementById('report-pdf-btn').style.display = 'none';
}
function generateComplaint() {
    var days = document.getElementById('report-days').value;
    var lang = document.getElementById('report-lang').value;
    var name = encodeURIComponent(document.getElementById('report-name').value);
    var number = encodeURIComponent(document.getElementById('report-number').value);
    var address = encodeURIComponent(document.getElementById('report-address').value);
    var btn = document.getElementById('report-generate-btn');
    btn.disabled = true;
    btn.textContent = '...';
    fetch('/api/complaint?days=' + days + '&lang=' + lang + '&name=' + name + '&number=' + number + '&address=' + address)
        .then(function(r) { return r.json(); })
        .then(function(data) {
            document.getElementById('report-complaint-text').value = data.text;
            document.getElementById('report-step1').style.display = 'none';
            document.getElementById('report-step2').style.display = 'block';
            document.getElementById('report-generate-btn').style.display = 'none';
            document.getElementById('report-copy-btn').style.display = '';
            document.getElementById('report-pdf-btn').style.display = '';
        })
        .catch(function(e) { alert('Error: ' + e); })
        .finally(function() { btn.disabled = false; btn.textContent = '\u270E Generate Letter'; });
}
function copyComplaint() {
    var textarea = document.getElementById('report-complaint-text');
    var btn = document.getElementById('report-copy-btn');
    textarea.select();
    textarea.setSelectionRange(0, textarea.value.length);
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(textarea.value).then(function() {
            var orig = btn.innerHTML;
            btn.innerHTML = '&#10003; Copied!';
            setTimeout(function() { btn.innerHTML = orig; }, 2000);
        });
    } else {
        document.execCommand('copy');
    }
}
function downloadReport() {
    var days = document.getElementById('report-days').value;
    var lang = document.getElementById('report-lang').value;
    window.location.href = '/api/report?days=' + days + '&lang=' + lang;
}
function copyExport() {
    var T = {{ t|tojson }};
    var textarea = document.getElementById('export-text');
    var btn = document.getElementById('export-copy-btn');
    textarea.select();
    textarea.setSelectionRange(0, textarea.value.length);
    var ok = false;
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(textarea.value).then(function() {
            btn.textContent = T.copied;
            setTimeout(function() { btn.textContent = T.copy_clipboard; }, 2000);
        }).catch(function() {
            fallbackCopy(textarea, btn, T);
        });
    } else {
        fallbackCopy(textarea, btn, T);
    }
}
function fallbackCopy(textarea, btn, T) {
    try {
        document.execCommand('copy');
        btn.textContent = T.copied;
        setTimeout(function() { btn.textContent = T.copy_clipboard; }, 2000);
    } catch(e) {
        btn.textContent = 'Select All + Ctrl+C';
        setTimeout(function() { btn.textContent = T.copy_clipboard; }, 3000);
    }
}
function toggleCard(el) {
    el.classList.toggle('open');
}
function openSpeedtestSetupModal() {
    document.getElementById('speedtest-setup-modal').classList.add('open');
}
function closeSpeedtestSetupModal() {
    document.getElementById('speedtest-setup-modal').classList.remove('open');
}
var _speedtestRawData = [];
var _speedtestAllData = [];
var _speedtestVisible = 50;
var _speedtestSortCol = 'timestamp';
var _speedtestSortDir = 'desc';

function formatSpeedtestTimestamp(ts) {
    if (!ts) return '';
    var d = new Date(ts);
    if (isNaN(d.getTime())) return ts;
    var dd = String(d.getDate()).padStart(2, '0');
    var mm = String(d.getMonth() + 1).padStart(2, '0');
    var yyyy = d.getFullYear();
    var hh = String(d.getHours()).padStart(2, '0');
    var min = String(d.getMinutes()).padStart(2, '0');
    return dd + '.' + mm + '.' + yyyy + ' ' + hh + ':' + min;
}

function loadSpeedtestHistory() {
    var T = {{ t|tojson }};
    var tbody = document.getElementById('speedtest-tbody');
    var table = document.getElementById('speedtest-table');
    var noData = document.getElementById('speedtest-no-data');
    var loading = document.getElementById('speedtest-loading');
    var moreWrap = document.getElementById('speedtest-show-more');
    if (!tbody || !table || !noData) return;
    tbody.innerHTML = '';
    table.style.display = 'none';
    noData.style.display = 'none';
    if (loading) loading.style.display = '';
    if (moreWrap) moreWrap.style.display = 'none';
    _speedtestRawData = [];
    _speedtestAllData = [];
    _speedtestVisible = 50;
    fetch('/api/speedtest?count=2000')
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (loading) loading.style.display = 'none';
            if (!data || data.length === 0) {
                noData.textContent = T.speedtest_no_data || 'No speedtest data.';
                noData.style.display = 'block';
                return;
            }
            _speedtestRawData = data;
            filterSpeedtestData();
        })
        .catch(function() {
            if (loading) loading.style.display = 'none';
            noData.textContent = T.network_error || 'Error';
            noData.style.display = 'block';
        });
}

function filterSpeedtestData() {
    var T = {{ t|tojson }};
    var daysEl = document.getElementById('speedtest-days');
    var days = daysEl ? daysEl.value : '7';
    var table = document.getElementById('speedtest-table');
    var noData = document.getElementById('speedtest-no-data');
    _speedtestVisible = 50;
    if (days === 'all') {
        _speedtestAllData = _speedtestRawData.slice();
    } else {
        var cutoff = new Date(Date.now() - parseInt(days) * 86400000);
        _speedtestAllData = _speedtestRawData.filter(function(r) {
            return new Date(r.timestamp) >= cutoff;
        });
    }
    sortSpeedtestData();
    if (_speedtestAllData.length === 0) {
        if (table) table.style.display = 'none';
        if (noData) {
            noData.textContent = T.speedtest_no_data || 'No speedtest data.';
            noData.style.display = 'block';
        }
        var cc = document.getElementById('speedtest-chart-container');
        if (cc) cc.style.display = 'none';
    } else {
        if (table) table.style.display = '';
        if (noData) noData.style.display = 'none';
        renderSpeedtestRows();
        renderSpeedtestChart();
    }
}

function sortSpeedtestData() {
    var col = _speedtestSortCol;
    var dir = _speedtestSortDir === 'asc' ? 1 : -1;
    _speedtestAllData.sort(function(a, b) {
        var va = a[col], vb = b[col];
        if (col === 'timestamp') {
            va = new Date(va || 0).getTime();
            vb = new Date(vb || 0).getTime();
        } else {
            va = parseFloat(va) || 0;
            vb = parseFloat(vb) || 0;
        }
        if (va < vb) return -1 * dir;
        if (va > vb) return 1 * dir;
        return 0;
    });
}

function handleSpeedtestSort(col) {
    if (_speedtestSortCol === col) {
        _speedtestSortDir = _speedtestSortDir === 'asc' ? 'desc' : 'asc';
    } else {
        _speedtestSortCol = col;
        _speedtestSortDir = col === 'timestamp' ? 'desc' : 'asc';
    }
    var ths = document.querySelectorAll('#speedtest-table thead th');
    ths.forEach(function(th) {
        var indicator = th.querySelector('.sort-indicator');
        if (indicator) {
            if (th.getAttribute('data-col') === col) {
                indicator.textContent = _speedtestSortDir === 'asc' ? '▲' : '▼';
            } else {
                indicator.textContent = '';
            }
        }
    });
    sortSpeedtestData();
    _speedtestVisible = 50;
    renderSpeedtestRows();
    renderSpeedtestChart();
}

function computeMedian(arr) {
    if (arr.length === 0) return 0;
    var sorted = arr.slice().sort(function(a, b) { return a - b; });
    var mid = Math.floor(sorted.length / 2);
    return sorted.length % 2 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
}

function renderSpeedtestRows() {
    var T = {{ t|tojson }};
    var tbody = document.getElementById('speedtest-tbody');
    var moreWrap = document.getElementById('speedtest-show-more');
    var moreBtn = document.getElementById('speedtest-more-btn');
    if (!tbody) return;
    tbody.innerHTML = '';
    var downloads = [], uploads = [];
    for (var j = 0; j < _speedtestAllData.length; j++) {
        var d = _speedtestAllData[j];
        if (d.download_mbps != null) downloads.push(parseFloat(d.download_mbps) || 0);
        if (d.upload_mbps != null) uploads.push(parseFloat(d.upload_mbps) || 0);
    }
    var medianDl = computeMedian(downloads);
    var medianUl = computeMedian(uploads);
    var show = Math.min(_speedtestVisible, _speedtestAllData.length);
    for (var i = 0; i < show; i++) {
        var r = _speedtestAllData[i];
        var dlVal = parseFloat(r.download_mbps) || 0;
        var ulVal = parseFloat(r.upload_mbps) || 0;
        var pingVal = parseFloat(r.ping_ms) || 0;
        var jitterVal = parseFloat(r.jitter_ms) || 0;
        var dlClass = (medianDl > 0 && dlVal < medianDl * 0.8) ? ' class="val-bad"' : '';
        var ulClass = (medianUl > 0 && ulVal < medianUl * 0.8) ? ' class="val-bad"' : '';
        var pingClass = pingVal > 50 ? ' class="val-warn"' : '';
        var jitterClass = jitterVal > 20 ? ' class="val-warn"' : '';
        var tr = document.createElement('tr');
        tr.innerHTML = '<td class="st-expand-col"><button class="st-expand-btn" data-id="' + r.id + '" onclick="toggleSpeedtestSignal(this)">&#9654;</button></td>'
            + '<td>' + escapeHtml(formatSpeedtestTimestamp(r.timestamp)) + '</td>'
            + '<td><strong' + dlClass + '>' + escapeHtml(r.download_human || (r.download_mbps + ' Mbps')) + '</strong></td>'
            + '<td><strong' + ulClass + '>' + escapeHtml(r.upload_human || (r.upload_mbps + ' Mbps')) + '</strong></td>'
            + '<td' + pingClass + '>' + r.ping_ms + ' ms</td>'
            + '<td' + jitterClass + '>' + r.jitter_ms + ' ms</td>'
            + '<td>' + (r.packet_loss_pct > 0 ? '<span class="val-warn">' + r.packet_loss_pct + '%</span>' : '0%') + '</td>';
        tbody.appendChild(tr);
    }
    if (moreWrap && moreBtn) {
        if (_speedtestAllData.length > _speedtestVisible) {
            moreWrap.style.display = '';
            moreBtn.textContent = (T.show_more || 'Show more') + ' (' + (_speedtestAllData.length - _speedtestVisible) + ')';
        } else {
            moreWrap.style.display = 'none';
        }
    }
}

function toggleSpeedtestSignal(btn) {
    var T = {{ t|tojson }};
    var id = btn.getAttribute('data-id');
    var parentRow = btn.closest('tr');
    var detailRow = parentRow.nextElementSibling;
    // If detail row exists and belongs to this entry, toggle it
    if (detailRow && detailRow.classList.contains('st-signal-row')) {
        detailRow.remove();
        btn.classList.remove('open');
        return;
    }
    // Create detail row and fetch data
    btn.classList.add('open');
    var newRow = document.createElement('tr');
    newRow.className = 'st-signal-row';
    var cols = parentRow.children.length;
    var td = document.createElement('td');
    td.colSpan = cols;
    td.innerHTML = '<div class="st-signal-detail"><span class="st-sig-no-data" style="text-align:center;">...</span></div>';
    newRow.appendChild(td);
    parentRow.after(newRow);
    fetch('/api/speedtest/' + id + '/signal')
        .then(function(r) { return r.json(); })
        .then(function(data) {
            var container = newRow.querySelector('.st-signal-detail');
            if (!data.found) {
                container.innerHTML = '<span class="st-sig-no-data">' + escapeHtml(data.message || T.signal_no_snapshot) + '</span>';
                return;
            }
            var healthClass = 'health-' + (data.health === 'good' ? 'good' : data.health === 'marginal' ? 'marginal' : 'poor');
            var healthLabel = data.health === 'good' ? (T.health_good || 'Good')
                : data.health === 'marginal' ? (T.health_marginal || 'Marginal')
                : (T.health_poor || 'Poor');
            var html = '<div class="st-sig-item"><span class="st-sig-label">' + (T.signal_health || 'Health') + '</span>'
                + '<span class="st-health-badge ' + healthClass + '">' + escapeHtml(healthLabel) + '</span></div>'
                + '<div class="st-sig-item"><span class="st-sig-label">' + (T.signal_ds_power || 'DS Power') + '</span>'
                + '<span class="st-sig-value">' + data.ds_power_min + ' / ' + data.ds_power_avg + ' / ' + data.ds_power_max + ' dBmV</span></div>'
                + '<div class="st-sig-item"><span class="st-sig-label">' + (T.signal_ds_snr || 'DS SNR') + '</span>'
                + '<span class="st-sig-value">' + data.ds_snr_min + ' / ' + data.ds_snr_avg + ' dB</span></div>'
                + '<div class="st-sig-item"><span class="st-sig-label">' + (T.signal_us_power || 'US Power') + '</span>'
                + '<span class="st-sig-value">' + data.us_power_min + ' / ' + data.us_power_avg + ' / ' + data.us_power_max + ' dBmV</span></div>'
                + '<div class="st-sig-item"><span class="st-sig-label">' + (T.signal_errors || 'Errors') + '</span>'
                + '<span class="st-sig-value">' + (data.ds_correctable_errors || 0).toLocaleString() + ' ' + (T.signal_corr || 'corr.') + ' / '
                + (data.ds_uncorrectable_errors || 0).toLocaleString() + ' ' + (T.signal_uncorr || 'uncorr.') + '</span></div>'
                + '<div class="st-sig-item"><span class="st-sig-label">' + (T.signal_ds_channels || 'DS') + ' / ' + (T.signal_us_channels || 'US') + '</span>'
                + '<span class="st-sig-value">' + (data.ds_total || 0) + ' / ' + (data.us_total || 0) + '</span></div>';
            if (data.us_channels && data.us_channels.length > 0) {
                html += '<div class="st-us-mods"><span class="st-sig-label">' + (T.signal_us_modulation || 'US Modulation') + ': </span>';
                for (var c = 0; c < data.us_channels.length; c++) {
                    var ch = data.us_channels[c];
                    html += '<span>Ch' + (ch.channel_id || c) + ': ' + escapeHtml(ch.modulation || '?') + '</span>';
                }
                html += '</div>';
            }
            html += '<div class="st-sig-item"><span class="st-sig-label">' + (T.signal_snapshot_time || 'Snapshot') + '</span>'
                + '<span class="st-sig-value" style="font-size:0.85em; color:var(--muted);">' + escapeHtml(data.snapshot_timestamp || '') + '</span></div>';
            container.innerHTML = html;
        })
        .catch(function() {
            var container = newRow.querySelector('.st-signal-detail');
            if (container) container.innerHTML = '<span class="st-sig-no-data">Error loading signal data</span>';
        });
}

function renderSpeedtestChart() {
    var container = document.getElementById('speedtest-chart-container');
    var canvas = document.getElementById('speedtest-chart');
    if (!container || !canvas) return;
    // Sort data chronologically for chart (oldest first)
    var data = _speedtestAllData.slice().sort(function(a, b) {
        return new Date(a.timestamp) - new Date(b.timestamp);
    });
    if (data.length < 2) { container.style.display = 'none'; return; }
    container.style.display = '';
    var wrap = canvas.parentElement;
    var dpr = window.devicePixelRatio || 1;
    var w = wrap.clientWidth;
    var h = canvas.clientHeight || 250;
    canvas.width = w * dpr;
    canvas.height = h * dpr;
    var ctx = canvas.getContext('2d');
    ctx.scale(dpr, dpr);
    // Padding
    var padL = 60, padR = 60, padT = 20, padB = 30;
    var cw = w - padL - padR;
    var ch = h - padT - padB;
    // Extract data arrays
    var dls = [], uls = [], pings = [], times = [];
    for (var i = 0; i < data.length; i++) {
        dls.push(parseFloat(data[i].download_mbps) || 0);
        uls.push(parseFloat(data[i].upload_mbps) || 0);
        pings.push(parseFloat(data[i].ping_ms) || 0);
        times.push(new Date(data[i].timestamp));
    }
    // Scales
    var maxSpeed = Math.max.apply(null, dls.concat(uls)) * 1.1 || 1;
    var maxPing = Math.max.apply(null, pings) * 1.1 || 1;
    var medianDl = computeMedian(dls);
    var threshold = medianDl * 0.8;
    function xPos(idx) { return padL + (idx / (data.length - 1)) * cw; }
    function ySpeed(v) { return padT + ch - (v / maxSpeed) * ch; }
    function yPing(v) { return padT + ch - (v / maxPing) * ch; }
    // Clear
    ctx.clearRect(0, 0, w, h);
    // Background zones (green/red tint per segment)
    for (var i = 0; i < data.length - 1; i++) {
        var x1 = xPos(i), x2 = xPos(i + 1);
        var isHealthy = dls[i] >= threshold && dls[i + 1] >= threshold;
        ctx.fillStyle = isHealthy ? 'rgba(34,197,94,0.06)' : 'rgba(239,68,68,0.06)';
        ctx.fillRect(x1, padT, x2 - x1, ch);
    }
    // Grid lines + left Y axis labels (speed)
    var cs = getComputedStyle(document.documentElement);
    var mutedColor = cs.getPropertyValue('--muted').trim() || '#888';
    ctx.strokeStyle = 'rgba(255,255,255,0.07)';
    ctx.lineWidth = 1;
    ctx.font = '11px monospace';
    ctx.textAlign = 'right';
    ctx.textBaseline = 'middle';
    var gridLines = 5;
    for (var g = 0; g <= gridLines; g++) {
        var gy = padT + (g / gridLines) * ch;
        var speedVal = maxSpeed - (g / gridLines) * maxSpeed;
        var pingVal = maxPing - (g / gridLines) * maxPing;
        ctx.beginPath();
        ctx.moveTo(padL, gy);
        ctx.lineTo(w - padR, gy);
        ctx.stroke();
        ctx.fillStyle = mutedColor;
        ctx.textAlign = 'right';
        ctx.fillText(speedVal.toFixed(0), padL - 6, gy);
        ctx.textAlign = 'left';
        ctx.fillText(pingVal.toFixed(0), w - padR + 6, gy);
    }
    ctx.fillStyle = mutedColor;
    ctx.font = '10px monospace';
    ctx.textAlign = 'center';
    ctx.save();
    ctx.translate(12, padT + ch / 2);
    ctx.rotate(-Math.PI / 2);
    ctx.fillText('Mbps', 0, 0);
    ctx.restore();
    ctx.save();
    ctx.translate(w - 10, padT + ch / 2);
    ctx.rotate(Math.PI / 2);
    ctx.fillText('ms', 0, 0);
    ctx.restore();
    // X axis labels (timestamps)
    ctx.fillStyle = mutedColor;
    ctx.font = '10px monospace';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'top';
    var labelCount = Math.min(6, data.length);
    for (var li = 0; li < labelCount; li++) {
        var idx = Math.round(li * (data.length - 1) / (labelCount - 1));
        var t = times[idx];
        var label = String(t.getDate()).padStart(2, '0') + '.' + String(t.getMonth() + 1).padStart(2, '0') + ' ' + String(t.getHours()).padStart(2, '0') + ':' + String(t.getMinutes()).padStart(2, '0');
        ctx.fillText(label, xPos(idx), padT + ch + 6);
    }
    // Threshold line (dashed red)
    ctx.setLineDash([6, 4]);
    ctx.strokeStyle = 'rgba(239,68,68,0.6)';
    ctx.lineWidth = 1.5;
    ctx.beginPath();
    var threshY = ySpeed(threshold);
    ctx.moveTo(padL, threshY);
    ctx.lineTo(w - padR, threshY);
    ctx.stroke();
    ctx.setLineDash([]);
    // Helper: draw filled line
    function drawLine(values, yFn, color, fillColor) {
        // Filled area
        ctx.beginPath();
        ctx.moveTo(xPos(0), padT + ch);
        for (var i = 0; i < values.length; i++) {
            ctx.lineTo(xPos(i), yFn(values[i]));
        }
        ctx.lineTo(xPos(values.length - 1), padT + ch);
        ctx.closePath();
        ctx.fillStyle = fillColor;
        ctx.fill();
        // Line
        ctx.beginPath();
        for (var i = 0; i < values.length; i++) {
            if (i === 0) ctx.moveTo(xPos(i), yFn(values[i]));
            else ctx.lineTo(xPos(i), yFn(values[i]));
        }
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.stroke();
    }
    drawLine(uls, ySpeed, '#22c55e', 'rgba(34,197,94,0.12)');
    drawLine(dls, ySpeed, '#3b82f6', 'rgba(59,130,246,0.15)');
    drawLine(pings, yPing, '#f59e0b', 'rgba(245,158,11,0.10)');
    // Hover interaction
    var tooltip = document.getElementById('speedtest-chart-tooltip');
    // Move tooltip to body so it's never clipped
    if (tooltip.parentElement !== document.body) document.body.appendChild(tooltip);
    tooltip.style.position = 'fixed';
    function onMouseMove(e) {
        var rect = canvas.getBoundingClientRect();
        var scaleX = w / rect.width;
        var scaleY = h / rect.height;
        var mx = (e.clientX - rect.left) * scaleX;
        var my = (e.clientY - rect.top) * scaleY;
        if (mx < padL || mx > w - padR || my < padT || my > padT + ch) {
            tooltip.style.display = 'none'; return;
        }
        var ratio = (mx - padL) / cw;
        var idx = Math.round(ratio * (data.length - 1));
        if (idx < 0) idx = 0;
        if (idx >= data.length) idx = data.length - 1;
        tooltip.style.display = 'block';
        tooltip.innerHTML = '<strong>' + formatSpeedtestTimestamp(data[idx].timestamp) + '</strong><br>'
            + '<span style="color:#3b82f6">&#9660;</span> DL: ' + dls[idx].toFixed(2) + ' Mbps<br>'
            + '<span style="color:#22c55e">&#9650;</span> UL: ' + uls[idx].toFixed(2) + ' Mbps<br>'
            + '<span style="color:#f59e0b">&#9679;</span> Ping: ' + pings[idx].toFixed(1) + ' ms';
        tooltip.style.left = (e.clientX + 14) + 'px';
        tooltip.style.top = (e.clientY - 10) + 'px';
    }
    function onMouseLeave() { tooltip.style.display = 'none'; }
    if (canvas._chartMoveHandler) canvas.removeEventListener('mousemove', canvas._chartMoveHandler);
    if (canvas._chartLeaveHandler) canvas.removeEventListener('mouseleave', canvas._chartLeaveHandler);
    canvas._chartMoveHandler = onMouseMove;
    canvas._chartLeaveHandler = onMouseLeave;
    canvas.addEventListener('mousemove', onMouseMove);
    canvas.addEventListener('mouseleave', onMouseLeave);
}
window.addEventListener('resize', function() {
    if (_speedtestAllData.length >= 2) renderSpeedtestChart();
});

function showMoreSpeedtest() {
    _speedtestVisible += 50;
    renderSpeedtestRows();
}

(function() {
    var ths = document.querySelectorAll('#speedtest-table thead th[data-col]');
    ths.forEach(function(th) {
        th.addEventListener('click', function() {
            handleSpeedtestSort(th.getAttribute('data-col'));
        });
    });
})();

function escapeHtml(str) {
    var div = document.createElement('div');
    div.appendChild(document.createTextNode(str));
    return div.innerHTML;
}

</script>

</body>
</html>
