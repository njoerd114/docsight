<!DOCTYPE html>
<html lang="{{ lang }}" data-theme="{{ theme|default('dark') }}">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>DOCSight</title>
    <style>
        :root, [data-theme="dark"] {
            --bg: #1a1a2e;
            --surface: #16213e;
            --card: #0f3460;
            --text: #e0e0e0;
            --muted: #888;
            --good: #4caf50;
            --warn: #ff9800;
            --crit: #f44336;
            --accent: #00adb5;
            --info: #2196f3;
            --input-border: rgba(255,255,255,0.15);
            --overlay: rgba(0,0,0,0.5);
        }
        [data-theme="light"] {
            --bg: #f0f2f5;
            --surface: #ffffff;
            --card: #e8edf2;
            --text: #1a1a2e;
            --muted: #666;
            --good: #2e7d32;
            --warn: #e65100;
            --crit: #c62828;
            --accent: #00838f;
            --info: #1565c0;
            --input-border: #ccc;
            --overlay: rgba(0,0,0,0.3);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace;
            background: var(--bg);
            color: var(--text);
            overflow-x: hidden;
        }

        /* ── Topbar ── */
        .topbar {
            display: flex; align-items: center; gap: 10px;
            padding: 10px 16px; background: var(--surface);
            border-bottom: 1px solid var(--input-border);
            position: sticky; top: 0; z-index: 50;
        }
        .hamburger-btn {
            background: none; border: none; color: var(--text);
            font-size: 1.5em; cursor: pointer; padding: 2px 6px;
            border-radius: 4px; line-height: 1;
        }
        .hamburger-btn:hover { color: var(--accent); }
        .date-nav { display: flex; align-items: center; gap: 2px; }
        .date-nav button {
            background: none; border: 1px solid var(--input-border);
            color: var(--text); border-radius: 4px; cursor: pointer;
            font-size: 0.85em; padding: 4px 8px;
        }
        .date-nav button:hover { border-color: var(--accent); color: var(--accent); }
        .date-label {
            font-size: 0.9em; font-weight: bold; padding: 4px 10px;
            cursor: pointer; border: 1px solid transparent;
            border-radius: 4px; white-space: nowrap;
        }
        .date-label:hover { border-color: var(--accent); }
        .topbar-title {
            flex: 1; font-size: 1.1em; color: var(--accent);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .topbar-meta { font-size: 0.8em; color: var(--muted); white-space: nowrap; }

        /* ── Layout ── */
        .app-layout { display: flex; min-height: 100vh; }

        /* ── Sidebar ── */
        .sidebar {
            width: 240px; min-width: 240px;
            background: var(--surface);
            display: flex; flex-direction: column;
            border-right: 1px solid var(--input-border);
            transition: width 0.25s ease, min-width 0.25s ease;
            overflow: hidden;
        }
        .sidebar.collapsed { width: 0; min-width: 0; }
        .sidebar-content { flex: 1; overflow-y: auto; }
        .sidebar-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px 20px; border-bottom: 1px solid var(--input-border);
            font-weight: bold; color: var(--accent); white-space: nowrap;
        }
        .sidebar-toggle {
            background: none; border: none; color: var(--muted);
            font-size: 1.2em; cursor: pointer; line-height: 1; padding: 2px 4px;
        }
        .sidebar-toggle:hover { color: var(--accent); }
        .app-main { flex: 1; min-width: 0; display: flex; flex-direction: column; }
        .sidebar-link {
            display: flex; align-items: center; gap: 10px;
            padding: 12px 20px; color: var(--text); text-decoration: none;
            font-size: 0.95em; cursor: pointer; transition: background 0.15s;
        }
        .sidebar-link:hover { background: var(--card); }
        .sidebar-link.active { color: var(--accent); background: rgba(0,173,181,0.1); }
        .sidebar-link .icon { font-size: 1.1em; width: 24px; text-align: center; }
        .sidebar-divider { border-top: 1px solid var(--input-border); margin: 8px 0; }
        .sidebar-ref { padding: 0 20px 16px; }
        .sidebar-ref summary {
            cursor: pointer; font-size: 0.9em; color: var(--muted);
            padding: 10px 0; list-style: none; display: flex;
            align-items: center; gap: 8px;
        }
        .sidebar-ref summary::-webkit-details-marker { display: none; }
        .sidebar-ref summary::before {
            content: "\25B6"; font-size: 0.6em; transition: transform 0.2s;
        }
        .sidebar-ref[open] summary::before { transform: rotate(90deg); }
        .sidebar-ref table {
            width: 100%; font-size: 0.78em; border-collapse: collapse; margin-top: 4px;
        }
        .sidebar-ref th, .sidebar-ref td { padding: 4px 6px; text-align: left; }
        .sidebar-ref th { color: var(--accent); position: static; background: transparent; }
        .sidebar-ref tr { border-bottom: 1px solid var(--input-border); }

        /* ── Calendar Popup ── */
        .calendar-popup {
            position: fixed; top: 52px; left: 80px;
            background: var(--surface); border: 1px solid var(--input-border);
            border-radius: 8px; padding: 12px; z-index: 80; display: none;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3); min-width: 280px;
        }
        .calendar-popup.open { display: block; }
        .cal-nav {
            display: flex; justify-content: space-between;
            align-items: center; margin-bottom: 8px;
        }
        .cal-nav button {
            background: none; border: 1px solid var(--input-border);
            color: var(--text); border-radius: 4px; cursor: pointer;
            padding: 4px 10px; font-size: 0.9em;
        }
        .cal-nav button:hover { border-color: var(--accent); }
        .cal-nav span { font-weight: bold; font-size: 0.95em; }
        .cal-weekdays {
            display: grid; grid-template-columns: repeat(7, 1fr);
            text-align: center; font-size: 0.75em; color: var(--muted); margin-bottom: 4px;
        }
        .cal-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .cal-day {
            text-align: center; padding: 6px 2px; font-size: 0.85em;
            border-radius: 4px; cursor: default; color: var(--muted);
        }
        .cal-day.has-data { color: var(--text); cursor: pointer; font-weight: bold; }
        .cal-day.has-data:hover { background: var(--card); }
        .cal-day.today { border: 1px solid var(--accent); }
        .cal-day.selected { background: var(--accent); color: #000; }
        .cal-day.empty { visibility: hidden; }

        /* ── Main Content ── */
        .main-content { padding: 16px; max-width: 1400px; margin: 0 auto; }
        .view { display: none; }
        .view.active { display: block; }

        /* ── Dashboard ── */
        .history-banner {
            padding: 10px 16px; border-radius: 6px;
            background: rgba(33,150,243,0.15); border: 1px solid var(--info);
            color: var(--info); font-size: 0.95em; margin-bottom: 16px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .history-banner a { color: var(--info); font-size: 0.85em; }
        .health-banner {
            padding: 16px 20px; border-radius: 8px; margin-bottom: 16px;
        }
        .health-good { background: rgba(76,175,80,0.1); border: 1px solid var(--good); }
        .health-warn { background: rgba(255,152,0,0.1); border: 1px solid var(--warn); }
        .health-crit { background: rgba(244,67,54,0.1); border: 1px solid var(--crit); }
        .health-status { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }
        .health-icon { font-size: 1.4em; }
        .health-good .health-icon { color: var(--good); }
        .health-warn .health-icon { color: var(--warn); }
        .health-crit .health-icon { color: var(--crit); }
        .health-title { font-size: 1.15em; font-weight: bold; }
        .health-good .health-title { color: var(--good); }
        .health-warn .health-title { color: var(--warn); }
        .health-crit .health-title { color: var(--crit); }
        .health-msg { font-size: 0.9em; color: var(--text); opacity: 0.85; margin-bottom: 4px; }
        .health-issues { margin-top: 10px; display: flex; flex-direction: column; gap: 8px; }
        .health-issue {
            padding: 8px 12px; border-radius: 6px;
            background: rgba(0,0,0,0.15);
        }
        .health-issue-name { font-weight: bold; font-size: 0.9em; display: block; }
        .health-issue-desc { font-size: 0.82em; color: var(--muted); margin-top: 2px; display: block; }
        h2.section-title { font-size: 1.1em; margin: 16px 0 8px; color: var(--accent); }
        .summary-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px; margin-bottom: 16px;
        }
        .summary-card { background: var(--surface); border-radius: 6px; padding: 12px; }
        .summary-card .label { font-size: 0.8em; color: var(--muted); }
        .summary-card .value { font-size: 1.3em; font-weight: bold; margin-top: 4px; }

        /* ── Tables ── */
        table { width: 100%; border-collapse: collapse; margin-bottom: 16px; font-size: 0.9em; }
        th, td { padding: 6px 10px; text-align: left; }
        th {
            background: var(--surface); color: var(--accent);
            position: sticky; top: 52px; cursor: pointer; user-select: none;
            white-space: nowrap;
        }
        th:hover { text-decoration: underline; }
        th.sort-asc::after { content: " \25B2"; font-size: 0.65em; }
        th.sort-desc::after { content: " \25BC"; font-size: 0.65em; }
        tr { border-bottom: 1px solid rgba(255,255,255,0.05); }
        tr:hover { background: rgba(255,255,255,0.03); }
        .badge {
            display: inline-block; padding: 2px 8px; border-radius: 4px;
            font-size: 0.8em; font-weight: bold;
        }
        .badge-good { background: rgba(76,175,80,0.25); color: var(--good); }
        .badge-warn { background: rgba(255,152,0,0.25); color: var(--warn); }
        .badge-crit { background: rgba(244,67,54,0.25); color: var(--crit); }
        .val-good { color: var(--good); }
        .val-warn { color: var(--warn); }
        .val-crit { color: var(--crit); }
        .error-box {
            background: rgba(244,67,54,0.15); border: 1px solid var(--crit);
            color: var(--crit); padding: 12px; border-radius: 6px; margin-bottom: 16px;
        }
        .waiting {
            text-align: center; padding: 60px 20px; color: var(--muted);
        }
        .waiting .spinner {
            display: inline-block; width: 30px; height: 30px;
            border: 3px solid var(--surface); border-top: 3px solid var(--accent);
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 12px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ── Collapsible Channel Groups ── */
        details.channel-group { margin-bottom: 4px; }
        details.channel-group summary {
            cursor: pointer; padding: 8px 12px; background: var(--surface);
            border-radius: 6px; font-size: 0.95em; font-weight: bold;
            color: var(--accent); list-style: none;
            display: flex; align-items: center; gap: 8px; user-select: none;
        }
        details.channel-group summary::-webkit-details-marker { display: none; }
        details.channel-group summary::before {
            content: "\25B6"; font-size: 0.65em; transition: transform 0.2s;
        }
        details.channel-group[open] summary::before { transform: rotate(90deg); }
        details.channel-group table { margin-top: 4px; }

        /* ── Trends ── */
        .trend-header {
            display: flex; justify-content: space-between;
            align-items: center; margin-bottom: 16px;
        }
        .trend-title { font-size: 1.2em; color: var(--accent); font-weight: bold; }
        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .chart-card { background: var(--surface); border-radius: 8px; padding: 16px; }
        .chart-card .chart-label { font-size: 0.85em; color: var(--muted); margin-bottom: 8px; }
        .chart-card canvas { width: 100% !important; }
        .no-data-msg {
            text-align: center; padding: 40px 20px;
            color: var(--muted); font-size: 0.95em;
        }

        /* ── Export Modal ── */
        .modal-overlay {
            position: fixed; inset: 0; background: var(--overlay);
            z-index: 200; display: none; justify-content: center; align-items: center;
        }
        .modal-overlay.open { display: flex; }
        .modal {
            background: var(--surface); border-radius: 10px;
            padding: 20px; max-width: 720px; width: 90%; max-height: 85vh;
            display: flex; flex-direction: column;
            border: 1px solid var(--input-border);
            box-shadow: 0 12px 40px rgba(0,0,0,0.4);
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 8px;
        }
        .modal-header h2 { font-size: 1.1em; color: var(--accent); margin: 0; }
        .modal-close {
            background: none; border: none; color: var(--muted);
            font-size: 1.4em; cursor: pointer; line-height: 1;
        }
        .modal-close:hover { color: var(--text); }
        .modal-hint { font-size: 0.85em; color: var(--muted); margin-bottom: 12px; }
        .modal-body {
            flex: 1; overflow-y: auto; margin-bottom: 12px;
        }
        .modal-body textarea {
            width: 100%; min-height: 300px; background: var(--bg);
            color: var(--text); border: 1px solid var(--input-border);
            border-radius: 6px; padding: 12px; font-size: 0.82em;
            font-family: 'Consolas', 'Monaco', monospace; resize: vertical;
        }
        .modal-footer { display: flex; gap: 10px; justify-content: flex-end; }
        .modal-footer .btn {
            display: inline-block; padding: 8px 20px; border: none;
            border-radius: 4px; cursor: pointer; font-size: 0.9em;
            font-family: inherit; font-weight: bold;
        }
        .btn-accent { background: var(--accent); color: #000; }
        .btn-accent:hover { filter: brightness(1.15); }
        .btn-muted {
            background: var(--card); color: var(--text);
            border: 1px solid var(--input-border);
        }
        .btn-muted:hover { background: var(--accent); color: #000; }

        /* ── Responsive ── */
        @media (max-width: 900px) {
            .charts-grid { grid-template-columns: 1fr; }
            .sidebar { width: 0; min-width: 0; }
            .sidebar.collapsed { width: 0; min-width: 0; }
        }
        @media (max-width: 600px) {
            body { font-size: 14px; }
            .topbar { gap: 6px; padding: 8px 10px; }
            .topbar-title { display: none; }
            .summary-grid { grid-template-columns: 1fr 1fr; }
            table { font-size: 0.8em; }
            th, td { padding: 4px 6px; }
            .calendar-popup { left: 10px; right: 10px; min-width: auto; }
        }
    </style>
</head>
<body>
<div class="app-layout">

<!-- Sidebar -->
<nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <span>DOCSight</span>
        <button class="sidebar-toggle" id="sidebar-collapse" title="Collapse">&#10094;</button>
    </div>
    <div class="sidebar-content">
        <a class="sidebar-link active" data-view="live">
            <span class="icon">&#9679;</span> {{ t.live_dashboard }}
        </a>
        <a class="sidebar-link" data-view="day">
            <span class="icon">&#9201;</span> {{ t.day_trend }}
        </a>
        <a class="sidebar-link" data-view="week">
            <span class="icon">&#9899;</span> {{ t.week_trend }}
        </a>
        <a class="sidebar-link" data-view="month">
            <span class="icon">&#128197;</span> {{ t.month_trend }}
        </a>
        <div class="sidebar-divider"></div>
        <a class="sidebar-link" href="/settings">
            <span class="icon">&#9881;</span> {{ t.settings }}
        </a>
        <a class="sidebar-link" id="export-link" onclick="exportForLLM()">
            <span class="icon">&#128196;</span> {{ t.export_llm }}
        </a>
        <div class="sidebar-divider"></div>
        <details class="sidebar-ref">
            <summary>{{ t.reference_values }}</summary>
            <table>
                <thead><tr><th>{{ t.metric }}</th><th>{{ t.good }}</th><th>{{ t.marginal }}</th><th>{{ t.poor }}</th></tr></thead>
                <tbody>
                    <tr><td>DS Power</td><td>-7..+7</td><td>&plusmn;7..10</td><td>&gt;&plusmn;10 dBmV</td></tr>
                    <tr><td>US Power</td><td>35..49</td><td>50..54</td><td>&gt;54 dBmV</td></tr>
                    <tr><td>SNR/MER</td><td>&gt;30 dB</td><td>25..30</td><td>&lt;25 dB</td></tr>
                    <tr><td>{{ t.uncorr }}</td><td>{{ t.low }}</td><td>-</td><td>&gt;10,000</td></tr>
                </tbody>
            </table>
        </details>
    </div>
</nav>

<!-- Main Area -->
<div class="app-main">

<!-- Topbar -->
<div class="topbar">
    <button class="hamburger-btn" id="hamburger" title="Menu">&#9776;</button>
    <div class="date-nav" id="date-nav">
        <button id="date-prev">&#8249;</button>
        <span class="date-label" id="date-label" title="{{ t.open_calendar }}">{{ t.live }}</span>
        <button id="date-next">&#8250;</button>
    </div>
    <span class="topbar-title">DOCSight</span>
    <span class="topbar-meta" id="topbar-meta">
        {% if last_update %}{{ t.last_update }}: {{ last_update }} | {{ poll_interval }}s{% endif %}
    </span>
</div>

<!-- Calendar Popup -->
<div class="calendar-popup" id="calendar-popup">
    <div class="cal-nav">
        <button id="cal-prev">&lsaquo;</button>
        <span id="cal-month-label"></span>
        <button id="cal-next">&rsaquo;</button>
    </div>
    <div class="cal-weekdays">
        <span>Mo</span><span>Tu</span><span>We</span><span>Th</span><span>Fr</span><span>Sa</span><span>Su</span>
    </div>
    <div class="cal-days" id="cal-days"></div>
</div>

<!-- ═══ View: Dashboard ═══ -->
<div class="main-content">
<div id="view-dashboard" class="view active">

{% if historical %}
<div class="history-banner">
    {{ t.historical_view }}: {{ snapshot_ts.replace("T", " ") }}
    <a href="/">{{ t.back_to_live }} &rarr;</a>
</div>
{% endif %}

{% if error %}
<div class="error-box">{{ t.error_label }}: {{ error }}</div>
{% endif %}

{% if analysis %}
    {% set s = analysis.summary %}
    {% set ds = analysis.ds_channels %}
    {% set us = analysis.us_channels %}

    {% set health_map = {"good": t.health_good, "marginal": t.health_marginal, "poor": t.health_poor} %}
    {% set health_label = health_map.get(s.health, s.health) %}
    {% set health_msgs = {"good": t.health_good_msg, "marginal": t.health_marginal_msg, "poor": t.health_poor_msg} %}
    {% set issue_labels = {
        "ds_power_critical": t.issue_ds_power_critical,
        "us_power_critical": t.issue_us_power_critical,
        "us_power_warn": t.issue_us_power_warn,
        "snr_critical": t.issue_snr_critical,
        "snr_warn": t.issue_snr_warn,
        "uncorr_errors_high": t.issue_uncorr_errors_high,
    } %}
    {% set issue_descs = {
        "ds_power_critical": t.issue_ds_power_critical_desc,
        "us_power_critical": t.issue_us_power_critical_desc,
        "us_power_warn": t.issue_us_power_warn_desc,
        "snr_critical": t.issue_snr_critical_desc,
        "snr_warn": t.issue_snr_warn_desc,
        "uncorr_errors_high": t.issue_uncorr_errors_high_desc,
    } %}

    <div class="health-banner health-{{ 'good' if s.health == 'good' else ('crit' if s.health == 'poor' else 'warn') }}">
        <div class="health-status">
            <span class="health-icon">{% if s.health == 'good' %}&#10004;{% elif s.health == 'poor' %}&#10006;{% else %}&#9888;{% endif %}</span>
            <span class="health-title">{{ health_label }}</span>
        </div>
        <div class="health-msg">{{ health_msgs.get(s.health, '') }}</div>
        {% if s.health_issues %}
        <div class="health-issues">
            {% for issue in s.health_issues %}
            <div class="health-issue">
                <span class="health-issue-name">{{ issue_labels.get(issue, issue) }}</span>
                <span class="health-issue-desc">{{ issue_descs.get(issue, '') }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <div class="summary-grid">
        {% if isp_name or connection_info %}
        <div class="summary-card">
            <div class="label">{{ t.tariff }}</div>
            <div class="value">{% if isp_name %}{{ isp_name }}{% endif %}{% if connection_info.max_downstream_kbps %} {{ connection_info.max_downstream_kbps // 1000 }}/{{ connection_info.max_upstream_kbps // 1000 }} Mbit/s{% endif %}</div>
        </div>
        {% endif %}
        <div class="summary-card">
            <div class="label">{{ t.ds_channels }}</div>
            <div class="value">{{ s.ds_total }}</div>
        </div>
        <div class="summary-card">
            <div class="label">{{ t.ds_power_range }}</div>
            <div class="value">{{ s.ds_power_min }} / {{ s.ds_power_avg }} / {{ s.ds_power_max }} dBmV</div>
        </div>
        <div class="summary-card">
            <div class="label">{{ t.ds_snr_range }}</div>
            <div class="value">{{ s.ds_snr_min }} / {{ s.ds_snr_avg }} dB</div>
        </div>
        <div class="summary-card">
            <div class="label">{{ t.ds_errors_label }}</div>
            <div class="value">{{ s.ds_correctable_errors|fmt_k }} / {{ s.ds_uncorrectable_errors|fmt_k }}</div>
        </div>
        <div class="summary-card">
            <div class="label">{{ t.us_channels }}</div>
            <div class="value">{{ s.us_total }}</div>
        </div>
        <div class="summary-card">
            <div class="label">{{ t.us_power_range }}</div>
            <div class="value">{{ s.us_power_min }} / {{ s.us_power_avg }} / {{ s.us_power_max }} dBmV</div>
        </div>
    </div>

    <h2 class="section-title">{{ t.downstream }} ({{ ds|length }} {{ t.channels }})</h2>
    {% for group in ds|sort(attribute='docsis_version', reverse=true)|groupby('docsis_version') %}
    <details class="channel-group">
        <summary>DOCSIS {{ group.grouper }} ({{ group.list|length }} {{ t.channels }})</summary>
        <table class="sortable">
            <thead><tr>
                <th>{{ t.status }}</th><th>{{ t.channel }}</th><th>{{ t.frequency }}</th><th>{{ t.power_dbmv }}</th>
                <th>{{ t.snr_db }}</th><th>{{ t.modulation }}</th><th>{{ t.corr }}</th><th>{{ t.uncorr }}</th>
            </tr></thead>
            <tbody>
            {% for ch in group.list %}
            <tr>
                {% set ch_tips = {"power critical": t.ch_power_critical, "power warning": t.ch_power_warning, "snr critical": t.ch_snr_critical, "snr warning": t.ch_snr_warning} %}
                {% set ch_tip_parts = [] %}
                {% for key, label in ch_tips.items() %}{% if key in ch.health_detail %}{% if ch_tip_parts.append(label) %}{% endif %}{% endif %}{% endfor %}
                <td data-sort="{{ 0 if ch.health == 'good' else (2 if ch.health == 'critical' else 1) }}">
                    {% if ch.health == "good" %}<span class="badge badge-good">{{ t.health_good }}</span>
                    {% elif ch.health == "critical" %}<span class="badge badge-crit" title="{{ ch_tip_parts|join(', ') }}">{{ t.health_critical }}</span>
                    {% else %}<span class="badge badge-warn" title="{{ ch_tip_parts|join(', ') }}">{{ t.health_warning }}</span>{% endif %}
                </td>
                <td data-sort="{{ ch.channel_id }}">{{ ch.channel_id }}</td>
                <td>{{ ch.frequency }}</td>
                <td data-sort="{{ ch.power if ch.power is not none else 0 }}" class="{% if ch.power is not none %}{% if ch.power|abs > 10 %}val-crit{% elif ch.power|abs > 7 %}val-warn{% else %}val-good{% endif %}{% endif %}">{{ ch.power }}</td>
                <td data-sort="{{ ch.snr if ch.snr is not none else 0 }}" class="{% if ch.snr is not none %}{% if ch.snr < 25 %}val-crit{% elif ch.snr < 30 %}val-warn{% else %}val-good{% endif %}{% endif %}">{{ ch.snr if ch.snr is not none else "-" }}</td>
                <td>{{ ch.modulation }}</td>
                <td data-sort="{{ ch.correctable_errors }}">{{ ch.correctable_errors|fmt_k }}</td>
                <td data-sort="{{ ch.uncorrectable_errors }}">{{ ch.uncorrectable_errors|fmt_k }}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </details>
    {% endfor %}

    <h2 class="section-title">{{ t.upstream }} ({{ us|length }} {{ t.channels }})</h2>
    {% for group in us|sort(attribute='docsis_version', reverse=true)|groupby('docsis_version') %}
    <details class="channel-group">
        <summary>DOCSIS {{ group.grouper }} ({{ group.list|length }} {{ t.channels }})</summary>
        <table class="sortable">
            <thead><tr>
                <th>{{ t.status }}</th><th>{{ t.channel }}</th><th>{{ t.frequency }}</th><th>{{ t.power_dbmv }}</th>
                <th>{{ t.modulation }}</th><th>{{ t.multiplex }}</th>
            </tr></thead>
            <tbody>
            {% for ch in group.list %}
            {% set ch_tip = t.ch_power_critical if 'power critical' in ch.health_detail else (t.ch_power_warning if 'power warning' in ch.health_detail else '') %}
            <tr>
                <td data-sort="{{ 0 if ch.health == 'good' else (2 if ch.health == 'critical' else 1) }}">
                    {% if ch.health == "good" %}<span class="badge badge-good">{{ t.health_good }}</span>
                    {% elif ch.health == "critical" %}<span class="badge badge-crit" title="{{ ch_tip }}">{{ t.health_critical }}</span>
                    {% else %}<span class="badge badge-warn" title="{{ ch_tip }}">{{ t.health_warning }}</span>{% endif %}
                </td>
                <td data-sort="{{ ch.channel_id }}">{{ ch.channel_id }}</td>
                <td>{{ ch.frequency }}</td>
                <td data-sort="{{ ch.power }}" class="{% if ch.power > 54 %}val-crit{% elif ch.power > 50 %}val-warn{% else %}val-good{% endif %}">{{ ch.power }}</td>
                <td>{{ ch.modulation }}</td>
                <td>{{ ch.multiplex }}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </details>
    {% endfor %}

{% elif not error %}
    <div class="waiting">
        <div class="spinner"></div>
        <p>{{ t.waiting_msg }}</p>
    </div>
{% endif %}
</div>

<!-- ═══ View: Trends ═══ -->
<div id="view-trends" class="view">
    <div class="trend-header">
        <span class="trend-title" id="trend-title"></span>
    </div>
    <div id="trend-no-data" class="no-data-msg" style="display:none"></div>
    <div class="charts-grid" id="charts-grid">
        <div class="chart-card">
            <div class="chart-label">{{ t.ds_power_avg }}</div>
            <canvas id="chart-ds-power"></canvas>
        </div>
        <div class="chart-card">
            <div class="chart-label">{{ t.ds_snr_avg }}</div>
            <canvas id="chart-ds-snr"></canvas>
        </div>
        <div class="chart-card">
            <div class="chart-label">{{ t.us_power_avg }}</div>
            <canvas id="chart-us-power"></canvas>
        </div>
        <div class="chart-card">
            <div class="chart-label">{{ t.errors }}</div>
            <canvas id="chart-errors"></canvas>
        </div>
    </div>
</div>
</div><!-- /main-content -->
</div><!-- /app-main -->
</div><!-- /app-layout -->

<!-- Export Modal -->
<div class="modal-overlay" id="export-modal">
    <div class="modal">
        <div class="modal-header">
            <h2>{{ t.export_title }}</h2>
            <button class="modal-close" onclick="closeExportModal()">&times;</button>
        </div>
        <p class="modal-hint">{{ t.export_hint }}</p>
        <div class="modal-body">
            <textarea id="export-text" readonly></textarea>
        </div>
        <div class="modal-footer">
            <button class="btn btn-muted" onclick="closeExportModal()">{{ t.close }}</button>
            <button class="btn btn-accent" id="export-copy-btn" onclick="copyExport()">{{ t.copy_clipboard }}</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<script>
(function() {
    'use strict';

    var T = {{ t|tojson }};

    /* ── Theme ── */
    var saved = localStorage.getItem('docsis-theme');
    if (saved) document.documentElement.setAttribute('data-theme', saved);

    /* ── State ── */
    var currentView = 'live';
    var selectedDate = todayStr();
    var calendarMonth = new Date();
    var datesWithData = [];
    var charts = {};
    var calendarLoaded = false;
    var isHistorical = {{ 'true' if historical else 'false' }};

    function todayStr() {
        var d = new Date();
        return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate());
    }
    function pad(n) { return n < 10 ? '0' + n : '' + n; }
    function formatDateDE(str) {
        var p = str.split('-');
        return p[2] + '.' + p[1] + '.' + p[0];
    }

    /* ── Sortable Tables ── */
    document.querySelectorAll('table.sortable').forEach(function(table) {
        var headers = table.querySelectorAll('th');
        headers.forEach(function(th, colIdx) {
            th.addEventListener('click', function() {
                sortTable(table, colIdx, th);
            });
        });
    });

    function sortTable(table, colIdx, th) {
        var tbody = table.querySelector('tbody');
        var rows = Array.from(tbody.querySelectorAll('tr'));
        var asc = th.getAttribute('data-sort-dir') !== 'asc';

        table.querySelectorAll('th').forEach(function(h) {
            h.removeAttribute('data-sort-dir');
            h.classList.remove('sort-asc', 'sort-desc');
        });
        th.setAttribute('data-sort-dir', asc ? 'asc' : 'desc');
        th.classList.add(asc ? 'sort-asc' : 'sort-desc');

        rows.sort(function(a, b) {
            var cellA = a.cells[colIdx];
            var cellB = b.cells[colIdx];
            var valA = cellA.getAttribute('data-sort') || cellA.textContent.trim();
            var valB = cellB.getAttribute('data-sort') || cellB.textContent.trim();
            var numA = parseFloat(valA);
            var numB = parseFloat(valB);
            if (!isNaN(numA) && !isNaN(numB)) {
                return asc ? numA - numB : numB - numA;
            }
            return asc ? valA.localeCompare(valB) : valB.localeCompare(valA);
        });
        rows.forEach(function(row) { tbody.appendChild(row); });
    }

    /* ── Sidebar ── */
    var sidebar = document.getElementById('sidebar');

    function collapseSidebar() { sidebar.classList.add('collapsed'); }
    function expandSidebar() { sidebar.classList.remove('collapsed'); }

    document.getElementById('sidebar-collapse').addEventListener('click', collapseSidebar);
    document.getElementById('hamburger').addEventListener('click', function() {
        sidebar.classList.toggle('collapsed');
    });

    var sidebarLinks = document.querySelectorAll('.sidebar-link[data-view]');
    sidebarLinks.forEach(function(link) {
        link.addEventListener('click', function() {
            switchView(this.getAttribute('data-view'));
        });
    });

    function switchView(view) {
        currentView = view;
        sidebarLinks.forEach(function(l) {
            l.classList.toggle('active', l.getAttribute('data-view') === view);
        });
        var dashView = document.getElementById('view-dashboard');
        var trendView = document.getElementById('view-trends');
        if (view === 'live') {
            dashView.classList.add('active');
            trendView.classList.remove('active');
            updateDateLabel();
            if (!isHistorical) startAutoRefresh();
        } else {
            dashView.classList.remove('active');
            trendView.classList.add('active');
            stopAutoRefresh();
            updateDateLabel();
            loadTrends(view, selectedDate);
        }
    }

    /* ── Date Navigation ── */
    var dateLabel = document.getElementById('date-label');
    var datePrev = document.getElementById('date-prev');
    var dateNext = document.getElementById('date-next');

    function updateDateLabel() {
        if (currentView === 'live') {
            dateLabel.textContent = isHistorical ? formatDateDE('{{ snapshot_ts[:10] if snapshot_ts else "" }}') : T.live;
        } else {
            var rangeLabel = {day: T.day, week: T.week, month: T.month}[currentView] || '';
            dateLabel.textContent = formatDateDE(selectedDate) + ' (' + rangeLabel + ')';
        }
    }

    datePrev.addEventListener('click', function() { dateNav(-1); });
    dateNext.addEventListener('click', function() { dateNav(1); });

    function dateNav(dir) {
        var d = new Date(selectedDate + 'T12:00:00');
        if (currentView === 'live' || currentView === 'day') {
            d.setDate(d.getDate() + dir);
        } else if (currentView === 'week') {
            d.setDate(d.getDate() + dir * 7);
        } else if (currentView === 'month') {
            d.setMonth(d.getMonth() + dir);
        }
        selectedDate = d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate());
        updateDateLabel();
        if (currentView === 'live') {
            fetch('/api/snapshot/daily?date=' + selectedDate)
                .then(function(r) { return r.json(); })
                .then(function(snap) {
                    if (snap && snap.timestamp) {
                        window.location.href = '/?t=' + encodeURIComponent(snap.timestamp);
                    }
                });
        } else {
            loadTrends(currentView, selectedDate);
        }
    }

    /* ── Calendar ── */
    var calPopup = document.getElementById('calendar-popup');

    dateLabel.addEventListener('click', function(e) {
        e.stopPropagation();
        calPopup.classList.toggle('open');
        if (calPopup.classList.contains('open') && !calendarLoaded) {
            loadCalendarData();
        } else if (calPopup.classList.contains('open')) {
            renderCalendar();
        }
    });
    document.addEventListener('click', function(e) {
        if (!calPopup.contains(e.target) && e.target !== dateLabel) {
            calPopup.classList.remove('open');
        }
    });
    document.getElementById('cal-prev').addEventListener('click', function() {
        calendarMonth.setMonth(calendarMonth.getMonth() - 1);
        renderCalendar();
    });
    document.getElementById('cal-next').addEventListener('click', function() {
        calendarMonth.setMonth(calendarMonth.getMonth() + 1);
        renderCalendar();
    });

    function loadCalendarData() {
        fetch('/api/calendar')
            .then(function(r) { return r.json(); })
            .then(function(dates) {
                datesWithData = dates;
                calendarLoaded = true;
                renderCalendar();
            });
    }

    function renderCalendar() {
        var year = calendarMonth.getFullYear();
        var month = calendarMonth.getMonth();
        document.getElementById('cal-month-label').textContent = T.months[month] + ' ' + year;
        var grid = document.getElementById('cal-days');
        grid.innerHTML = '';
        var firstDay = new Date(year, month, 1).getDay();
        var offset = (firstDay === 0) ? 6 : firstDay - 1;
        var daysInMonth = new Date(year, month + 1, 0).getDate();
        var today = todayStr();
        for (var i = 0; i < offset; i++) {
            var empty = document.createElement('span');
            empty.className = 'cal-day empty';
            grid.appendChild(empty);
        }
        for (var d = 1; d <= daysInMonth; d++) {
            var dateStr = year + '-' + pad(month + 1) + '-' + pad(d);
            var el = document.createElement('span');
            el.className = 'cal-day';
            el.textContent = d;
            if (datesWithData.indexOf(dateStr) !== -1) el.classList.add('has-data');
            if (dateStr === today) el.classList.add('today');
            if (dateStr === selectedDate) el.classList.add('selected');
            el.setAttribute('data-date', dateStr);
            el.addEventListener('click', function() {
                var date = this.getAttribute('data-date');
                if (!this.classList.contains('has-data')) return;
                selectedDate = date;
                calPopup.classList.remove('open');
                if (currentView === 'live') {
                    fetch('/api/snapshot/daily?date=' + date)
                        .then(function(r) { return r.json(); })
                        .then(function(snap) {
                            if (snap && snap.timestamp) {
                                window.location.href = '/?t=' + encodeURIComponent(snap.timestamp);
                            }
                        });
                } else {
                    updateDateLabel();
                    loadTrends(currentView, selectedDate);
                }
            });
            grid.appendChild(el);
        }
    }

    /* ── Auto Refresh ── */
    var refreshTimer = null;
    function startAutoRefresh() {
        stopAutoRefresh();
        refreshTimer = setInterval(function() {
            if (currentView === 'live' && !isHistorical && !document.hidden) {
                location.reload();
            }
        }, 60000);
    }
    function stopAutoRefresh() {
        if (refreshTimer) { clearInterval(refreshTimer); refreshTimer = null; }
    }
    if (!isHistorical) startAutoRefresh();

    /* ── Trend Charts ── */
    function loadTrends(range, date) {
        var title = document.getElementById('trend-title');
        var noData = document.getElementById('trend-no-data');
        var grid = document.getElementById('charts-grid');
        var labels = {day: T.day_trend, week: T.week_trend, month: T.month_trend};
        title.textContent = (labels[range] || 'Trend') + ' - ' + formatDateDE(date);

        fetch('/api/trends?range=' + range + '&date=' + date)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (!data || data.length === 0) {
                    noData.textContent = T.no_data;
                    noData.style.display = 'block';
                    grid.style.display = 'none';
                    return;
                }
                noData.style.display = 'none';
                grid.style.display = '';
                var xLabels = data.map(function(d) {
                    if (range === 'day') return d.timestamp ? d.timestamp.substring(11, 16) : '';
                    return d.date ? formatDateDE(d.date) : '';
                });
                renderChart('chart-ds-power', xLabels,
                    [{label: 'DS Power Avg', data: data.map(function(d){ return d.ds_power_avg; }), color: '#00adb5'}]);
                renderChart('chart-ds-snr', xLabels,
                    [{label: 'DS SNR Avg', data: data.map(function(d){ return d.ds_snr_avg; }), color: '#4caf50'}]);
                renderChart('chart-us-power', xLabels,
                    [{label: 'US Power Avg', data: data.map(function(d){ return d.us_power_avg; }), color: '#ff9800'}]);
                renderChart('chart-errors', xLabels, [
                    {label: T.correctable, data: data.map(function(d){ return d.ds_correctable_errors; }), color: '#2196f3'},
                    {label: T.uncorrectable, data: data.map(function(d){ return d.ds_uncorrectable_errors; }), color: '#f44336'}
                ], 'bar');
            })
            .catch(function() {
                noData.textContent = T.trend_error;
                noData.style.display = 'block';
                grid.style.display = 'none';
            });
    }

    function renderChart(canvasId, labels, datasets, type) {
        if (charts[canvasId]) charts[canvasId].destroy();
        var ctx = document.getElementById(canvasId);
        if (!ctx) return;
        var isDark = document.documentElement.getAttribute('data-theme') !== 'light';
        var gridColor = isDark ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.08)';
        var textColor = isDark ? '#888' : '#666';
        var chartDatasets = datasets.map(function(ds) {
            return {
                label: ds.label, data: ds.data,
                borderColor: ds.color,
                backgroundColor: ds.color + (type === 'bar' ? 'cc' : '22'),
                borderWidth: 2, tension: 0.3,
                pointRadius: labels.length > 30 ? 0 : 3,
                fill: type !== 'bar'
            };
        });
        charts[canvasId] = new Chart(ctx, {
            type: type || 'line',
            data: { labels: labels, datasets: chartDatasets },
            options: {
                responsive: true, maintainAspectRatio: true,
                interaction: { intersect: false, mode: 'index' },
                plugins: {
                    legend: { display: datasets.length > 1, labels: { color: textColor, font: { size: 11 } } },
                    tooltip: { backgroundColor: isDark ? '#16213e' : '#fff', titleColor: textColor, bodyColor: textColor, borderColor: gridColor, borderWidth: 1 }
                },
                scales: {
                    x: { ticks: { color: textColor, font: { size: 10 }, maxRotation: 45 }, grid: { color: gridColor } },
                    y: { ticks: { color: textColor, font: { size: 10 } }, grid: { color: gridColor } }
                }
            }
        });
    }

    /* ── Init ── */
    updateDateLabel();
})();

/* ── Export for LLM ── */
function exportForLLM() {
    var T = {{ t|tojson }};
    var modal = document.getElementById('export-modal');
    var textarea = document.getElementById('export-text');
    textarea.value = T.export_no_data;
    modal.classList.add('open');
    fetch('/api/export')
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.text) {
                textarea.value = data.text;
            } else if (data.error) {
                textarea.value = data.error;
            }
        })
        .catch(function() {
            textarea.value = 'Error loading export data.';
        });
}
function closeExportModal() {
    document.getElementById('export-modal').classList.remove('open');
}
function copyExport() {
    var T = {{ t|tojson }};
    var textarea = document.getElementById('export-text');
    var btn = document.getElementById('export-copy-btn');
    textarea.select();
    textarea.setSelectionRange(0, textarea.value.length);
    var ok = false;
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(textarea.value).then(function() {
            btn.textContent = T.copied;
            setTimeout(function() { btn.textContent = T.copy_clipboard; }, 2000);
        }).catch(function() {
            fallbackCopy(textarea, btn, T);
        });
    } else {
        fallbackCopy(textarea, btn, T);
    }
}
function fallbackCopy(textarea, btn, T) {
    try {
        document.execCommand('copy');
        btn.textContent = T.copied;
        setTimeout(function() { btn.textContent = T.copy_clipboard; }, 2000);
    } catch(e) {
        btn.textContent = 'Select All + Ctrl+C';
        setTimeout(function() { btn.textContent = T.copy_clipboard; }, 3000);
    }
}
</script>

</body>
</html>
